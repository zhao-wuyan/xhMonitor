{
  "_metadata": {
    "extraction_source": "code_import",
    "source_file": "ui-preview-v2.html",
    "description": "历史数据曲线设计模式 - 包含峰谷值标记、渐隐效果、动态缩放等高级特性",
    "extraction_date": "2026-01-31",
    "code_sections": {
      "MiniChart": "lines 813-1058",
      "DynamicScaler": "lines 1060-1105",
      "chart_styles": "lines 295-317"
    }
  },

  "chart_engine": {
    "name": "MiniChart",
    "description": "通用迷你图表引擎，支持左侧渐隐和动态峰谷标注",
    "features": [
      "实时数据流可视化",
      "左侧50%渐隐效果",
      "动态峰谷值标记",
      "渐变填充",
      "响应式画布",
      "自定义格式化函数"
    ],

    "rendering": {
      "canvas_setup": {
        "description": "Canvas 2D 渲染上下文",
        "resize_strategy": "响应式调整，监听 window resize 事件",
        "debounce": "100ms",
        "source": "ui-preview-v2.html:831-835"
      },

      "coordinate_mapping": {
        "description": "数据点映射到画布坐标",
        "x_axis": {
          "formula": "index * stepX",
          "stepX": "width / (data.length - 1)",
          "description": "均匀分布在画布宽度上"
        },
        "y_axis": {
          "formula": "topPadding + drawHeight - (val / maxValue) * drawHeight",
          "topPadding": "15px",
          "bottomPadding": "15px",
          "drawHeight": "height - topPadding - bottomPadding",
          "description": "从底部向上映射，支持自定义 maxValue"
        },
        "source": "ui-preview-v2.html:851-862"
      },

      "curve_drawing": {
        "description": "绘制平滑曲线",
        "stroke": {
          "color": "动态颜色（根据指标类型）",
          "width": "2.5px",
          "lineJoin": "round",
          "lineCap": "round"
        },
        "path": "使用 Canvas lineTo 连接所有数据点",
        "source": "ui-preview-v2.html:867-878"
      },

      "gradient_fill": {
        "description": "曲线下方渐变填充",
        "type": "linearGradient",
        "direction": "垂直（从上到下）",
        "stops": [
          {
            "position": 0,
            "color": "hexToRgba(color, 0.35)",
            "description": "顶部 35% 不透明度"
          },
          {
            "position": 1,
            "color": "hexToRgba(color, 0.0)",
            "description": "底部完全透明"
          }
        ],
        "source": "ui-preview-v2.html:880-889"
      }
    },

    "fade_effect": {
      "name": "左侧50%渐隐效果",
      "description": "使用 destination-out 合成模式擦除左侧区域，创造历史数据淡出效果",
      "technique": "globalCompositeOperation = 'destination-out'",
      "gradient": {
        "type": "linearGradient",
        "direction": "水平（从左到右）",
        "width": "画布宽度的 50%",
        "stops": [
          {
            "position": 0,
            "color": "rgba(0, 0, 0, 1)",
            "effect": "完全擦除（100% 透明）"
          },
          {
            "position": 0.6,
            "color": "rgba(0, 0, 0, 0.5)",
            "effect": "半透明（50% 可见）"
          },
          {
            "position": 1,
            "color": "rgba(0, 0, 0, 0)",
            "effect": "不擦除（100% 可见）"
          }
        ]
      },
      "visual_effect": "历史数据从左侧逐渐淡出，最新数据在右侧完全可见",
      "source": "ui-preview-v2.html:893-902",
      "code_snippet": "ctx.save();\nctx.globalCompositeOperation = 'destination-out';\nconst fadeGradient = ctx.createLinearGradient(0, 0, width * 0.5, 0);\nfadeGradient.addColorStop(0, 'rgba(0, 0, 0, 1)');\nfadeGradient.addColorStop(0.6, 'rgba(0, 0, 0, 0.5)');\nfadeGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');\nctx.fillStyle = fadeGradient;\nctx.fillRect(0, 0, width * 0.5, height);\nctx.restore();"
    },

    "peak_valley_markers": {
      "name": "动态峰谷值标记系统",
      "description": "自动检测并标注数据的峰值和谷值，跟随数据流动更新",

      "detection_algorithm": {
        "name": "改进的峰谷检测算法",
        "description": "只保留显著的峰谷，遵循峰-谷-峰-谷交替规律",
        "steps": [
          {
            "step": 1,
            "name": "候选极值点检测",
            "logic": "对于每个数据点 i，如果 curr > prev && curr > next，则为峰值；如果 curr < prev && curr < next，则为谷值",
            "source": "ui-preview-v2.html:913-925"
          },
          {
            "step": 2,
            "name": "峰谷交替过滤",
            "logic": "确保峰谷交替出现，同类型只保留更极端的值",
            "min_amplitude": 5,
            "description": "相邻极值点的幅度差必须大于 5",
            "source": "ui-preview-v2.html:927-958"
          },
          {
            "step": 3,
            "name": "标记生命周期管理",
            "operations": [
              "清理已移出视图的标记（index < 0）",
              "更新现有标记索引（数据左移，index--）",
              "添加新出现的极值标记（只在右侧 5 个数据点内）",
              "移除被更极端值替代的标记"
            ],
            "source": "ui-preview-v2.html:960-995"
          }
        ]
      },

      "marker_rendering": {
        "element": "div.chart-peak-marker",
        "positioning": "absolute",
        "classes": ["chart-peak-marker", "max|min"],
        "styles": {
          "max": {
            "color": "图表颜色（动态）",
            "description": "峰值使用图表主色"
          },
          "min": {
            "color": "#94a3b8",
            "description": "谷值使用次要文本色"
          },
          "transform": {
            "max": "translate(-50%, -100%) + margin-top: -6px",
            "min": "translate(-50%, 0) + margin-top: 6px",
            "description": "峰值在上方，谷值在下方"
          },
          "transition": "left 0.3s ease, top 0.3s ease, opacity 0.3s ease",
          "background": "rgba(0, 0, 0, 0.7)",
          "padding": "2px 5px",
          "border_radius": "3px",
          "font_size": "0.65rem",
          "font_weight": 600
        },
        "source": "ui-preview-v2.html:295-317, 1030-1043"
      },

      "fade_integration": {
        "description": "标记也受左侧渐隐效果影响",
        "formula": "opacity = Math.min(1, pt.x / (width * 0.5))",
        "behavior": "标记在左侧 50% 区域内逐渐淡出，与曲线同步",
        "source": "ui-preview-v2.html:1024-1027"
      },

      "update_strategy": {
        "frequency": "每次 draw() 调用时更新",
        "position_tracking": "根据数据点索引动态计算 x, y 坐标",
        "value_formatting": "使用自定义 formatFn 格式化显示值",
        "source": "ui-preview-v2.html:1015-1027"
      }
    }
  },

  "dynamic_scaling": {
    "name": "DynamicScaler",
    "description": "网络流量动态缩放控制器 - 自动调整 Y 轴上限以适应数据范围",
    "use_case": "用于网络流量等波动较大的指标，避免固定上限导致的显示问题",

    "parameters": {
      "initialMax": {
        "default": 1024,
        "unit": "KB/s",
        "description": "初始上限值（20MB/s for network）"
      },
      "shrinkDelay": {
        "default": 3000,
        "unit": "ms",
        "description": "缩小延迟时间，避免频繁抖动"
      },
      "minFloor": {
        "value": 10,
        "unit": "KB/s",
        "description": "最小底线，防止缩放到 0"
      }
    },

    "scaling_strategy": {
      "target_calculation": {
        "description": "让最大值处于 90% 高度",
        "formula": "targetMax = maxInWindow / 0.9",
        "rationale": "保留 10% 顶部空间，避免曲线贴顶",
        "source": "ui-preview-v2.html:1077-1078"
      },

      "instant_scale_up": {
        "name": "立即拔高机制",
        "trigger": "targetMax > currentMax",
        "condition": "当前值超过当前上限的 90%（安全区）",
        "action": "立即更新 currentMax = targetMax",
        "side_effect": "重置缩小计时器（lowUsageStartTime = null）",
        "rationale": "快速响应流量突增，避免曲线超出画布",
        "source": "ui-preview-v2.html:1080-1085"
      },

      "delayed_scale_down": {
        "name": "延迟缩小机制",
        "trigger": "maxInWindow < currentMax * 0.6",
        "condition": "当前窗口最大值不到上限的 60%",
        "delay": "3000ms（shrinkDelay）",
        "action": "平滑过渡向目标值逼近",
        "interpolation": {
          "method": "Linear Interpolation (Lerp)",
          "factor": 0.2,
          "formula": "currentMax = currentMax + (targetMax - currentMax) * 0.2",
          "effect": "每次更新缩小 20% 的差距，视觉上缓缓下降"
        },
        "rationale": "避免流量下降时立即缩小导致的抖动，提供平滑的视觉体验",
        "source": "ui-preview-v2.html:1086-1097"
      },

      "stable_zone": {
        "name": "稳定区间",
        "range": "60% - 90% 之间",
        "action": "保持当前上限不变",
        "side_effect": "重置缩小计时器",
        "rationale": "在合理范围内保持稳定，避免频繁调整",
        "source": "ui-preview-v2.html:1098-1101"
      }
    },

    "visual_behavior": {
      "scale_up": "瞬间拔高，曲线立即适应新范围",
      "scale_down": "缓慢下降，曲线平滑过渡",
      "stability": "在 60%-90% 区间内保持稳定，减少抖动"
    },

    "usage_example": {
      "initialization": "const netScaler = new DynamicScaler(20480); // 初始 20MB",
      "update": "const netMax = netScaler.update(stream.net);",
      "draw": "charts.net.draw(stream.net, netMax);",
      "source": "ui-preview-v2.html:1110, 1343-1344"
    }
  },

  "chart_instances": {
    "description": "6 个图表实例，每个使用不同的颜色和格式化函数",
    "instances": [
      {
        "id": "chart-cpu",
        "color": "var(--color-cpu) #3b82f6",
        "format": "v.toFixed(0) + '%'",
        "max_value": 100,
        "description": "CPU 使用率"
      },
      {
        "id": "chart-ram",
        "color": "var(--color-ram) #8b5cf6",
        "format": "(v / 100 * 32).toFixed(1) + 'G'",
        "max_value": 100,
        "description": "RAM 使用量（映射到 32GB）"
      },
      {
        "id": "chart-gpu",
        "color": "var(--color-gpu) #10b981",
        "format": "v.toFixed(0) + '%'",
        "max_value": 100,
        "description": "GPU 使用率"
      },
      {
        "id": "chart-vram",
        "color": "var(--color-vram) #f59e0b",
        "format": "(v / 100 * 24).toFixed(1) + 'G'",
        "max_value": 100,
        "description": "VRAM 使用量（映射到 24GB）"
      },
      {
        "id": "chart-net",
        "color": "var(--color-net) #0ea5e9",
        "format": "fmtNet(v)",
        "max_value": "动态（DynamicScaler）",
        "description": "网络流量（动态上限）",
        "special": "使用 DynamicScaler 自动调整 Y 轴范围"
      },
      {
        "id": "chart-pwr",
        "color": "var(--color-pwr) #f43f5e",
        "format": "v.toFixed(0) + 'W'",
        "max_value": 600,
        "description": "功耗（固定 600W 上限）"
      }
    ],
    "source": "ui-preview-v2.html:1123-1130"
  },

  "data_flow": {
    "description": "数据流处理和更新机制",
    "buffer_size": 40,
    "update_interval": "1000ms",
    "flow": [
      {
        "step": 1,
        "name": "数据生成",
        "source": "DataStream.next()",
        "description": "模拟生成新数据点"
      },
      {
        "step": 2,
        "name": "数据移位",
        "operation": "arr.shift() + arr.push(val)",
        "description": "移除最旧数据，添加最新数据"
      },
      {
        "step": 3,
        "name": "动态缩放",
        "operation": "netScaler.update(stream.net)",
        "description": "仅网络流量使用动态缩放"
      },
      {
        "step": 4,
        "name": "图表绘制",
        "operation": "charts.*.draw(data, maxValue)",
        "description": "重绘所有图表"
      },
      {
        "step": 5,
        "name": "标记更新",
        "operation": "updateMarkers(data, points)",
        "description": "更新峰谷值标记位置和可见性"
      }
    ],
    "source": "ui-preview-v2.html:1316-1348"
  },

  "performance_optimizations": {
    "canvas_resize": {
      "technique": "防抖（debounce）",
      "delay": "100ms",
      "rationale": "避免频繁 resize 导致的性能问题"
    },
    "marker_lifecycle": {
      "technique": "增量更新",
      "operations": [
        "只添加新出现的标记",
        "只移除移出视图的标记",
        "复用现有 DOM 元素"
      ],
      "rationale": "减少 DOM 操作，提升性能"
    },
    "gradient_caching": {
      "technique": "每次绘制时创建渐变",
      "note": "Canvas 渐变对象无法缓存（依赖画布尺寸）"
    }
  },

  "accessibility": {
    "color_contrast": "所有图表颜色与背景对比度 > 4.5:1",
    "text_readability": "峰谷值标记使用高对比度背景（rgba(0,0,0,0.7)）",
    "responsive": "图表自动适应容器尺寸"
  },

  "code_snippets": {
    "MiniChart_class": {
      "lines": "813-1058",
      "file": "ui-preview-v2.html",
      "description": "完整的 MiniChart 类实现"
    },
    "DynamicScaler_class": {
      "lines": "1060-1105",
      "file": "ui-preview-v2.html",
      "description": "完整的 DynamicScaler 类实现"
    },
    "chart_marker_styles": {
      "lines": "295-317",
      "file": "ui-preview-v2.html",
      "description": "峰谷值标记的 CSS 样式"
    },
    "chart_initialization": {
      "lines": "1123-1130",
      "file": "ui-preview-v2.html",
      "description": "6 个图表实例的初始化代码"
    },
    "update_loop": {
      "lines": "1316-1348",
      "file": "ui-preview-v2.html",
      "description": "主更新循环，包含数据生成和图表绘制"
    }
  }
}
