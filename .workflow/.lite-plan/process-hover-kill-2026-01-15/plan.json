{
  "summary": "在进程悬浮窗的 ProcessRowTemplate 中添加 kill 进程功能。鼠标悬浮时在进程名称右侧显示灰色 ✕ 按钮（hover 变红），点击后按钮变红色需再次点击确认，kill 失败时在窗口顶部显示 Toast 通知。",
  "approach": "遵循现有 WPF MVVM 架构和 ProcessActionRequested 事件扩展模式。在 FloatingWindow.xaml 的 ProcessRowTemplate 中添加 overlay kill 按钮（使用 MouseEnter/MouseLeave 控制显示），在 FloatingWindow.xaml.cs 中添加两步确认的点击事件处理器，在 App.xaml.cs 的 OnProcessActionRequested 中扩展 kill 逻辑（使用 Process.Kill），并添加 Toast 通知组件用于错误反馈。",
  "tasks": [
    {
      "id": "T1",
      "title": "实现进程悬浮窗 kill 按钮 UI 和交互逻辑",
      "scope": "XhMonitor.Desktop/FloatingWindow (XAML + code-behind)",
      "action": "Add",
      "description": "在 FloatingWindow.xaml 的 ProcessRowTemplate 中添加 overlay kill 按钮（灰色 ✕ hover 变红），在 FloatingWindow.xaml.cs 中实现两步确认的点击事件处理器和 ProcessActionRequested 事件触发。",
      "modification_points": [
        {
          "file": "XhMonitor.Desktop/FloatingWindow.xaml",
          "target": "ProcessRowTemplate DataTemplate:79-153",
          "change": "在 ProcessName 列（DisplayName TextBlock 后）添加 overlay kill 按钮 TextBlock，使用 MouseEnter/MouseLeave 控制 Visibility，绑定 ColorTextSub（默认）和 ColorRed（hover/confirmed）"
        },
        {
          "file": "XhMonitor.Desktop/FloatingWindow.xaml.cs",
          "target": "Event handlers section",
          "change": "添加 KillButton_Click 事件处理器（两步确认逻辑：首次点击变红色并设置 Tag='confirmed'，再次点击触发 ProcessActionRequested 事件），添加 KillButton_MouseEnter/MouseLeave 处理器（hover 变红色效果）"
        }
      ],
      "implementation": [
        "在 FloatingWindow.xaml ProcessRowTemplate 的 ProcessName Grid.Column=\"0\" 内，DisplayName TextBlock 后添加 kill 按钮 TextBlock：Text=\"✕\", FontSize=\"14\", Margin=\"5,0,0,0\", Cursor=\"Hand\", Visibility=\"Collapsed\", Name=\"KillButton\", Foreground=\"{StaticResource ColorTextSub}\"",
        "在 ProcessRow Border 的 MouseEnter 事件中添加逻辑：找到 KillButton 并设置 Visibility=\"Visible\"；在 MouseLeave 中设置 Visibility=\"Collapsed\"（如果 Tag != 'confirmed'）",
        "在 FloatingWindow.xaml.cs 添加 KillButton_Click 事件处理器：检查 sender.Tag，如果为 null 则设置 Tag='confirmed' 并改变 Foreground 为 ColorRed，如果为 'confirmed' 则从 DataContext 获取 ProcessRowViewModel，触发 ProcessActionRequested 事件（Action='kill', ProcessId, ProcessName）",
        "添加 KillButton_MouseEnter 处理器：如果 Tag != 'confirmed'，设置 Foreground 为 ColorRed；添加 KillButton_MouseLeave 处理器：如果 Tag != 'confirmed'，恢复 Foreground 为 ColorTextSub",
        "在所有 KillButton 事件处理器中添加 e.Handled = true 防止事件冒泡到 ProcessRow_RightClick"
      ],
      "reference": {
        "pattern": "MouseEnter/MouseLeave hover pattern + ProcessActionRequested event extension",
        "files": [
          "XhMonitor.Desktop/FloatingWindow.xaml (line 79-153 ProcessRowTemplate, line 239-252 MonitorBar hover pattern)",
          "XhMonitor.Desktop/FloatingWindow.xaml.cs (line 428-436 ProcessRow_RightClick pattern, line 58 ProcessActionRequested event)"
        ],
        "examples": "参考 PinnedCard 的 Unpin 按钮样式（line 168 红色 ✕），参考 MonitorBar_MouseEnter/Leave 的 Opacity 动画模式（lines 239-252）"
      },
      "acceptance": [
        "鼠标悬浮在进程行时，进程名称右侧显示灰色 ✕ 按钮",
        "鼠标悬浮在 ✕ 按钮上时，按钮变为红色",
        "首次点击 ✕ 按钮后，按钮保持红色且不消失",
        "再次点击红色 ✕ 按钮后，触发 ProcessActionRequested 事件（Action='kill'）"
      ]
    },
    {
      "id": "T2",
      "title": "实现 kill 进程逻辑和 Toast 错误通知",
      "scope": "XhMonitor.Desktop/App.xaml.cs + Toast 组件",
      "action": "Update",
      "description": "在 App.xaml.cs 的 OnProcessActionRequested 事件处理器中添加 Action='kill' 分支，调用 Process.Kill(entireProcessTree: true)，捕获异常并显示 Toast 通知。创建简单的 Toast 通知组件用于非阻塞错误提示。",
      "modification_points": [
        {
          "file": "XhMonitor.Desktop/App.xaml.cs",
          "target": "OnProcessActionRequested:214-222",
          "change": "添加 if (e.Action == 'kill') 分支，使用 Process.GetProcessById(e.ProcessId).Kill(entireProcessTree: true)，捕获 UnauthorizedAccessException/InvalidOperationException 并调用 ShowToast 方法"
        },
        {
          "file": "XhMonitor.Desktop/FloatingWindow.xaml",
          "target": "Root Grid",
          "change": "在根 Grid 顶部添加 Toast 容器 Border（初始 Visibility=\"Collapsed\"），包含错误消息 TextBlock 和淡入淡出动画"
        },
        {
          "file": "XhMonitor.Desktop/FloatingWindow.xaml.cs",
          "target": "New method",
          "change": "添加 ShowToast(string message) 方法，设置 Toast 文本和 Visibility，启动 3 秒后自动隐藏的 DispatcherTimer"
        }
      ],
      "implementation": [
        "在 App.xaml.cs OnProcessActionRequested 方法中添加 else if (e.Action == \"kill\") 分支",
        "在 kill 分支中使用 try-catch：Process.GetProcessById(e.ProcessId).Kill(entireProcessTree: true)，catch UnauthorizedAccessException 时调用 _floatingWindow?.ShowToast($\"无权限关闭进程 {e.ProcessName}（PID: {e.ProcessId}）\")，catch InvalidOperationException 时调用 ShowToast($\"进程 {e.ProcessName} 已退出\")",
        "在 FloatingWindow.xaml 根 Grid 的第一个子元素位置添加 Toast Border：Background=\"#CC000000\", CornerRadius=\"4\", Padding=\"12,8\", HorizontalAlignment=\"Center\", VerticalAlignment=\"Top\", Margin=\"0,10,0,0\", Visibility=\"Collapsed\", Name=\"ToastBorder\"，内含 TextBlock（Name=\"ToastMessage\", Foreground=\"White\", FontSize=\"12\"）",
        "在 FloatingWindow.xaml.cs 添加 public void ShowToast(string message) 方法：设置 ToastMessage.Text = message，ToastBorder.Visibility = Visible，创建 DispatcherTimer（Interval = 3 秒），Tick 事件中设置 Visibility = Collapsed 并停止 timer",
        "在 ShowToast 中添加淡入淡出动画（可选）：使用 DoubleAnimation 控制 ToastBorder.Opacity 从 0 到 1（0.2 秒），3 秒后从 1 到 0（0.3 秒）"
      ],
      "reference": {
        "pattern": "Process.Kill pattern + non-blocking notification",
        "files": [
          "XhMonitor.Desktop/App.xaml.cs (line 369 Kill method example, line 214-222 OnProcessActionRequested handler)",
          "XhMonitor.Desktop/FloatingWindow.xaml (line 27 ColorRed brush for error styling)"
        ],
        "examples": "参考 App.xaml.cs line 212 的 MessageBox.Show 错误提示模式，改为非阻塞 Toast"
      },
      "acceptance": [
        "点击确认后的 kill 按钮，成功关闭进程（进程从列表中消失）",
        "尝试 kill 系统进程或无权限进程时，窗口顶部显示 Toast 错误提示（3 秒后自动消失）",
        "Toast 提示包含进程名称和 PID 信息",
        "Toast 显示期间不阻塞 UI 交互"
      ]
    }
  ],
  "focus_paths": [
    "XhMonitor.Desktop/FloatingWindow.xaml",
    "XhMonitor.Desktop/FloatingWindow.xaml.cs",
    "XhMonitor.Desktop/App.xaml.cs"
  ],
  "estimated_time": "45 minutes",
  "recommended_execution": "Agent",
  "complexity": "Low",
  "_metadata": {
    "timestamp": "2026-01-15T08:00:00+08:00",
    "source": "direct-planning",
    "planning_mode": "direct",
    "exploration_angles": ["patterns"],
    "duration_seconds": 120
  }
}
