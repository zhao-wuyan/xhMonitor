{
  "summary": "基于用户澄清的进程名称显示增强方案:使用混合策略(内置规则+自定义正则)在 ProcessScanner 层实现名称解析,添加 DisplayName 属性并持久化到数据库,配置化规则管理,完整的 xUnit 测试覆盖。",
  "approach": "在 ProcessScanner 创建 ProcessInfo 时集成 IProcessNameResolver 服务,使用内置策略(LlamaCpp, Python, Node)和配置化正则模式提取友好名称。DisplayName 与 ProcessName 并存,持久化到 ProcessMetricRecord 表。失败时回退到 'ProcessName: ExtractedPart' 格式。添加 xUnit 测试项目验证 50+ 真实命令行场景。",
  "tasks": [
    {
      "id": "T1",
      "title": "创建 ProcessNameResolver 服务和内置策略",
      "scope": "XhMonitor.Core/Services/, XhMonitor.Core/Interfaces/",
      "action": "Create",
      "description": "创建 IProcessNameResolver 接口和 ProcessNameResolver 服务,实现内置策略(LlamaCppStrategy, PythonScriptStrategy, NodeJsStrategy)和配置化 RegexStrategy。使用责任链模式按优先级尝试策略。",
      "modification_points": [
        {
          "file": "XhMonitor.Core/Interfaces/IProcessNameResolver.cs",
          "target": "new file",
          "change": "定义接口: string Resolve(string processName, string commandLine)"
        },
        {
          "file": "XhMonitor.Core/Services/ProcessNameResolver.cs",
          "target": "new file",
          "change": "实现服务,注入 IConfiguration,加载 appsettings.json 规则,责任链调用策略"
        },
        {
          "file": "XhMonitor.Core/Services/Strategies/LlamaCppStrategy.cs",
          "target": "new file",
          "change": "提取 --model/-m 参数值,返回 'llama-server: model_name' 格式"
        },
        {
          "file": "XhMonitor.Core/Services/Strategies/PythonScriptStrategy.cs",
          "target": "new file",
          "change": "提取 .py 文件名,返回 'python: script.py' 格式"
        },
        {
          "file": "XhMonitor.Core/Services/Strategies/NodeJsStrategy.cs",
          "target": "new file",
          "change": "提取 .js 文件名,返回 'node: app.js' 格式"
        },
        {
          "file": "XhMonitor.Core/Services/Strategies/RegexStrategy.cs",
          "target": "new file",
          "change": "从 appsettings.json 加载自定义正则规则,缓存编译后的 Regex 对象"
        }
      ],
      "implementation": [
        "创建 IProcessNameResolver 接口,定义 Resolve(string processName, string commandLine) 方法",
        "实现 ProcessNameResolver 服务,构造函数接受 IConfiguration 和 ILogger",
        "从 appsettings.json Monitor:ProcessNameRules 加载自定义正则规则",
        "实现责任链:内置策略(LlamaCpp, Python, NodeJs) → 自定义正则 → 回退到 'ProcessName: (no rule)'",
        "每个策略实现 TryExtract(processName, commandLine, out displayName) 返回 bool",
        "RegexStrategy 缓存编译后的 Regex 对象避免重复编译",
        "线程安全:策略无状态或使用线程本地状态",
        "失败处理:捕获异常,记录 Debug 级别日志,回退到原始 ProcessName"
      ],
      "reference": {
        "pattern": "Provider Pattern + Strategy Pattern",
        "files": [
          "XhMonitor.Core/Interfaces/IMetricProvider.cs",
          "XhMonitor.Service/Core/MetricProviderRegistry.cs"
        ],
        "examples": "参考 IMetricProvider 的 DisplayName 模式和 MetricProviderRegistry 的责任链模式"
      },
      "acceptance": [
        "IProcessNameResolver 接口定义完成",
        "ProcessNameResolver 服务实现 3 个内置策略 + 1 个正则策略",
        "策略按优先级执行:内置 → 自定义正则 → 回退",
        "Regex 对象被缓存,线程安全",
        "失败时回退到 'ProcessName: (no rule)' 格式,仅 Debug 日志"
      ]
    },
    {
      "id": "T2",
      "title": "扩展数据模型添加 DisplayName 属性",
      "scope": "XhMonitor.Core/Models/, XhMonitor.Desktop/Models/, XhMonitor.Core/Entities/",
      "action": "Update",
      "description": "在 ProcessInfo 域模型、ProcessInfoDto 传输对象和 ProcessMetricRecord 实体中添加 DisplayName 属性。保持 ProcessInfo 不可变性,ProcessMetricRecord 需要数据库迁移。",
      "modification_points": [
        {
          "file": "XhMonitor.Core/Models/ProcessInfo.cs",
          "target": "properties:5-8",
          "change": "添加 public string? DisplayName { get; init; } 属性"
        },
        {
          "file": "XhMonitor.Desktop/Models/ProcessInfoDto.cs",
          "target": "properties:10-17",
          "change": "添加 [JsonPropertyName(\"displayName\")] public string DisplayName { get; set; } = string.Empty;"
        },
        {
          "file": "XhMonitor.Core/Entities/ProcessMetricRecord.cs",
          "target": "properties",
          "change": "添加 public string? DisplayName { get; set; } 属性"
        }
      ],
      "implementation": [
        "ProcessInfo 添加 DisplayName 属性,使用 init-only setter 保持不可变性",
        "ProcessInfoDto 添加 DisplayName 属性,JsonPropertyName 属性用于序列化",
        "ProcessMetricRecord 添加 DisplayName 列,nullable string 类型",
        "确保 DisplayName 在 ProcessInfo 中可为 null(string?),表示可选值",
        "ProcessInfoDto DisplayName 默认为空字符串,向后兼容"
      ],
      "reference": {
        "pattern": "DTO Pattern + Entity Pattern",
        "files": [
          "XhMonitor.Core/Models/ProcessInfo.cs",
          "XhMonitor.Desktop/Models/ProcessInfoDto.cs",
          "XhMonitor.Core/Entities/ProcessMetricRecord.cs"
        ],
        "examples": "遵循现有属性模式:ProcessInfo 使用 required init,DTO 使用 JsonPropertyName,Entity 使用可空属性"
      },
      "acceptance": [
        "ProcessInfo 有 DisplayName 属性,init-only setter",
        "ProcessInfoDto 有 DisplayName 属性,JsonPropertyName 特性",
        "ProcessMetricRecord 有 DisplayName 列,nullable string",
        "现有代码编译通过(向后兼容)",
        "DisplayName 在 SignalR 传输中正确序列化"
      ]
    },
    {
      "id": "T3",
      "title": "集成 ProcessNameResolver 到 ProcessScanner",
      "scope": "XhMonitor.Service/Core/, XhMonitor.Service/",
      "action": "Update",
      "description": "在 ProcessScanner 构造函数注入 IProcessNameResolver,在 ProcessSingleProcess() 方法中调用 Resolve() 设置 DisplayName。在 Program.cs 注册服务。",
      "modification_points": [
        {
          "file": "XhMonitor.Service/Core/ProcessScanner.cs",
          "target": "constructor:13-21",
          "change": "添加 IProcessNameResolver 参数到构造函数"
        },
        {
          "file": "XhMonitor.Service/Core/ProcessScanner.cs",
          "target": "ProcessSingleProcess:75-107",
          "change": "在 line 75 后调用 _nameResolver.Resolve(),在 ProcessInfo 创建时设置 DisplayName"
        },
        {
          "file": "XhMonitor.Service/Program.cs",
          "target": "service registration",
          "change": "注册 IProcessNameResolver 为 Singleton"
        }
      ],
      "implementation": [
        "在 ProcessScanner 添加 IProcessNameResolver _nameResolver 字段",
        "更新构造函数接受 IProcessNameResolver 并赋值给字段",
        "在 line 75 (commandLine 提取后)调用: string displayName = _nameResolver.Resolve(processName, commandLine ?? string.Empty);",
        "更新 ProcessInfo 创建(lines 101-107)包含 DisplayName = displayName",
        "在 Program.cs 注册: builder.Services.AddSingleton<IProcessNameResolver, ProcessNameResolver>();",
        "确保 resolver 调用在 try-catch 内,防止进程扫描失败"
      ],
      "reference": {
        "pattern": "Dependency Injection",
        "files": [
          "XhMonitor.Service/Core/ProcessScanner.cs",
          "XhMonitor.Service/Program.cs"
        ],
        "examples": "遵循现有 DI 模式,ProcessScanner 构造函数注入 ILogger 和 IConfiguration"
      },
      "acceptance": [
        "ProcessScanner 构造函数接受 IProcessNameResolver",
        "Resolver 在 ProcessSingleProcess() 中 CommandLine 提取后调用",
        "DisplayName 在 ProcessInfo 创建时设置",
        "服务在 Program.cs DI 容器中注册",
        "即使名称解析失败,进程扫描也继续"
      ],
      "depends_on": ["T1", "T2"]
    },
    {
      "id": "T4",
      "title": "更新 UI ViewModel 显示友好名称",
      "scope": "XhMonitor.Desktop/ViewModels/",
      "action": "Update",
      "description": "修改 FloatingWindowViewModel.ProcessRowViewModel 使用 DisplayName 而非 ProcessName 显示。更新 UpdateFrom() 方法处理 DTO 的 DisplayName,实现回退逻辑。",
      "modification_points": [
        {
          "file": "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs",
          "target": "ProcessRowViewModel:370-429",
          "change": "添加 DisplayName 属性,更新 UpdateFrom() 从 DTO 设置 DisplayName"
        },
        {
          "file": "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs",
          "target": "UpdateFrom:411-419",
          "change": "添加 DisplayName = dto.DisplayName ?? dto.ProcessName; 处理回退"
        }
      ],
      "implementation": [
        "在 ProcessRowViewModel 添加 DisplayName 属性,使用 INotifyPropertyChanged 模式",
        "更新 UpdateFrom() 方法从 DTO 设置 DisplayName,回退到 ProcessName",
        "实现回退逻辑: DisplayName = !string.IsNullOrEmpty(dto.DisplayName) ? dto.DisplayName : dto.ProcessName;",
        "保留 ProcessName 属性供内部使用(过滤、日志)",
        "UI 绑定将在 T5 更新为使用 DisplayName"
      ],
      "reference": {
        "pattern": "MVVM Pattern",
        "files": [
          "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs"
        ],
        "examples": "遵循现有 ProcessName 属性模式(lines 374-379),使用 SetField 辅助方法进行变更通知"
      },
      "acceptance": [
        "ProcessRowViewModel 有 DisplayName 属性,实现 INotifyPropertyChanged",
        "UpdateFrom() 从 DTO 设置 DisplayName,回退到 ProcessName",
        "属性变更通知正常工作",
        "原始 ProcessName 属性保留供内部使用"
      ],
      "depends_on": ["T2"]
    },
    {
      "id": "T5",
      "title": "配置提取规则和更新 UI 绑定",
      "scope": "XhMonitor.Service/, XhMonitor.Desktop/",
      "action": "Configure",
      "description": "在 appsettings.json 添加 ProcessNameRules 配置节,包含内置规则和自定义正则示例。更新 FloatingWindow.xaml 绑定显示 DisplayName。",
      "modification_points": [
        {
          "file": "XhMonitor.Service/appsettings.json",
          "target": "Monitor section:13-16",
          "change": "添加 ProcessNameRules 数组,包含 llamacpp, python, node 的正则规则"
        },
        {
          "file": "XhMonitor.Desktop/Views/FloatingWindow.xaml",
          "target": "ProcessName bindings",
          "change": "更新 TextBlock 绑定从 ProcessName 到 DisplayName"
        }
      ],
      "implementation": [
        "在 appsettings.json 添加 Monitor:ProcessNameRules 节,结构: [{ \"ProcessName\": \"llama-server\", \"Pattern\": \"--model\\\\s+([^\\\\s]+)\", \"Group\": 1, \"Format\": \"llama-server: {0}\" }]",
        "包含规则: llama-server (--model/-m 标志), python (script.py 文件名), node (script.js 文件名)",
        "添加 Enabled 全局开关和 EnabledProcesses 白名单配置",
        "更新 FloatingWindow.xaml TextBlock 绑定使用 DisplayName 属性",
        "测试配置加载在 ProcessNameResolver 构造函数",
        "验证 UI 显示配置进程的友好名称"
      ],
      "reference": {
        "pattern": "Configuration Pattern",
        "files": [
          "XhMonitor.Service/appsettings.json"
        ],
        "examples": "遵循现有 Monitor:Keywords 模式(lines 13-16),使用嵌套数组结构"
      },
      "acceptance": [
        "appsettings.json 有 ProcessNameRules 节,包含 3+ 规则",
        "配置被 ProcessNameResolver 正确加载",
        "UI 显示匹配规则的进程的 DisplayName",
        "UI 对无规则的进程回退到 ProcessName"
      ],
      "depends_on": ["T4"]
    },
    {
      "id": "T6",
      "title": "数据库迁移添加 DisplayName 列",
      "scope": "XhMonitor.Core/Entities/, XhMonitor.Service/",
      "action": "Create",
      "description": "创建 EF Core 迁移添加 DisplayName 列到 ProcessMetricRecord 表。更新 Repository 保存 DisplayName。测试迁移和数据一致性。",
      "modification_points": [
        {
          "file": "XhMonitor.Service/Migrations/",
          "target": "new migration file",
          "change": "创建迁移添加 DisplayName 列(nullable string)"
        },
        {
          "file": "XhMonitor.Service/Repositories/MetricRepository.cs",
          "target": "SaveMetricsAsync",
          "change": "更新保存逻辑包含 DisplayName 字段"
        }
      ],
      "implementation": [
        "运行 dotnet ef migrations add AddDisplayNameToProcessMetricRecord",
        "验证迁移文件正确添加 DisplayName 列(nullable string, no default)",
        "更新 MetricRepository.SaveMetricsAsync() 从 ProcessInfo 保存 DisplayName",
        "测试迁移:应用到测试数据库,验证列添加成功",
        "测试数据一致性:保存带 DisplayName 的记录,查询验证",
        "测试向后兼容:现有记录 DisplayName 为 null,不影响查询"
      ],
      "reference": {
        "pattern": "EF Core Migration",
        "files": [
          "XhMonitor.Service/Migrations/"
        ],
        "examples": "参考现有迁移文件结构和命名约定"
      },
      "acceptance": [
        "迁移文件创建成功,添加 DisplayName 列",
        "MetricRepository 保存 DisplayName 到数据库",
        "迁移应用到数据库成功",
        "现有数据不受影响(DisplayName 为 null)",
        "新记录正确保存 DisplayName"
      ],
      "depends_on": ["T2", "T3"]
    },
    {
      "id": "T7",
      "title": "创建 xUnit 测试项目和测试固件",
      "scope": "XhMonitor.Tests/",
      "action": "Create",
      "description": "创建 xUnit 测试项目,添加 50+ 真实命令行示例的测试固件。测试内置策略、自定义正则、失败处理、线程安全。",
      "modification_points": [
        {
          "file": "XhMonitor.Tests/XhMonitor.Tests.csproj",
          "target": "new file",
          "change": "创建测试项目,引用 xUnit, FluentAssertions, Moq"
        },
        {
          "file": "XhMonitor.Tests/Fixtures/CommandLineFixtures.cs",
          "target": "new file",
          "change": "定义 50+ 真实命令行示例和期望的 DisplayName"
        },
        {
          "file": "XhMonitor.Tests/Services/ProcessNameResolverTests.cs",
          "target": "new file",
          "change": "测试 ProcessNameResolver 的所有策略和边缘情况"
        },
        {
          "file": "XhMonitor.Tests/Services/StrategyTests.cs",
          "target": "new file",
          "change": "单独测试每个策略(LlamaCpp, Python, NodeJs, Regex)"
        }
      ],
      "implementation": [
        "创建 XhMonitor.Tests 项目,添加 NuGet 包: xUnit (2.6+), FluentAssertions (6.12+), Moq (4.20+)",
        "创建 CommandLineFixtures.cs,定义测试数据类: (ProcessName, CommandLine, ExpectedDisplayName)",
        "包含 50+ 场景: llamacpp (--model, -m), python (script.py, module.py), node (app.js, index.js), java (-jar), dotnet (run), 特殊字符, Unicode, 长路径, 空 CommandLine",
        "创建 ProcessNameResolverTests.cs,使用 [Theory] 和 [MemberData] 进行数据驱动测试",
        "测试内置策略优先级:LlamaCpp → Python → NodeJs → Regex → Fallback",
        "测试自定义正则:从 IConfiguration mock 加载规则,验证提取",
        "测试失败处理:格式错误的 CommandLine,正则超时,异常捕获",
        "测试线程安全:并行执行 Resolve(),验证无竞态条件",
        "测试回退格式:'ProcessName: ExtractedPart' 或 'ProcessName: (no rule)'"
      ],
      "reference": {
        "pattern": "xUnit Data-Driven Testing",
        "files": [
          "SqliteTest/Program.cs"
        ],
        "examples": "参考 SqliteTest 的测试模式,但使用 xUnit 框架和断言"
      },
      "acceptance": [
        "XhMonitor.Tests 项目创建,包含 xUnit, FluentAssertions, Moq",
        "CommandLineFixtures.cs 包含 50+ 测试场景",
        "ProcessNameResolverTests.cs 覆盖所有策略和边缘情况",
        "所有测试通过,代码覆盖率 > 80%",
        "测试可在 CI/CD 管道中运行"
      ],
      "depends_on": ["T1"]
    }
  ],
  "focus_paths": [
    "XhMonitor.Core/Interfaces/IProcessNameResolver.cs",
    "XhMonitor.Core/Services/ProcessNameResolver.cs",
    "XhMonitor.Core/Services/Strategies/",
    "XhMonitor.Core/Models/ProcessInfo.cs",
    "XhMonitor.Desktop/Models/ProcessInfoDto.cs",
    "XhMonitor.Core/Entities/ProcessMetricRecord.cs",
    "XhMonitor.Service/Core/ProcessScanner.cs",
    "XhMonitor.Service/Program.cs",
    "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs",
    "XhMonitor.Service/appsettings.json",
    "XhMonitor.Desktop/Views/FloatingWindow.xaml",
    "XhMonitor.Service/Migrations/",
    "XhMonitor.Tests/"
  ],
  "estimated_time": "3-4 hours",
  "recommended_execution": "Agent",
  "complexity": "Medium",
  "_metadata": {
    "timestamp": "2026-01-13T00:00:00Z",
    "source": "direct-planning-revised",
    "planning_mode": "clarification-based",
    "exploration_angles": ["patterns", "integration-points", "testing"],
    "clarification_rounds": 3,
    "total_clarifications": 12,
    "duration_seconds": 600,
    "changes_from_original": [
      "添加 T6: 数据库迁移任务(用户选择持久化 DisplayName)",
      "添加 T7: xUnit 测试项目任务(用户选择正式测试框架)",
      "T1: 调整为混合策略(内置+正则),失败格式改为 'ProcessName: ExtractedPart'",
      "T3: 集成点确认为 ProcessScanner(Option A)",
      "T5: 配置节添加全局开关和白名单",
      "所有任务: 错误处理改为 Debug 级别日志"
    ]
  }
}
