{
  "summary": "进程名称显示增强方案:使用两种提取器(正则提取器+直接名称提取器)在 ProcessScanner 层实现名称解析,通过 ProcessName + Keywords 两级匹配精确定位进程类型,添加 DisplayName 属性并持久化到数据库,配置化规则管理,完整的 xUnit 测试覆盖。",
  "approach": "在 ProcessScanner 创建 ProcessInfo 时集成 IProcessNameResolver 服务,使用两种提取器(RegexExtractor 和 DirectNameExtractor)从配置化规则中提取友好名称。匹配逻辑采用两级过滤:ProcessName + Keywords,与现有进程发现逻辑一致。DisplayName 与 ProcessName 并存,持久化到 ProcessMetricRecord 表。失败时回退到 'ProcessName: ExtractedPart' 格式。添加 xUnit 测试项目验证 50+ 真实命令行场景。",
  "tasks": [
    {
      "id": "T1",
      "title": "创建 ProcessNameResolver 服务和两种提取器",
      "scope": "XhMonitor.Core/Services/, XhMonitor.Core/Interfaces/, XhMonitor.Core/Models/",
      "action": "Create",
      "description": "创建 IProcessNameResolver 接口和 ProcessNameResolver 服务,实现两种提取器(RegexExtractor 和 DirectNameExtractor)。使用 ProcessName + Keywords 两级匹配逻辑,所有规则从 appsettings.json 配置加载。",
      "modification_points": [
        {
          "file": "XhMonitor.Core/Interfaces/IProcessNameResolver.cs",
          "target": "new file",
          "change": "定义接口: string Resolve(string processName, string commandLine)"
        },
        {
          "file": "XhMonitor.Core/Models/ProcessNameRule.cs",
          "target": "new file",
          "change": "定义配置模型类,包含 ProcessName, Keywords, Type, Pattern, Group, Format, DisplayName 字段"
        },
        {
          "file": "XhMonitor.Core/Services/ProcessNameResolver.cs",
          "target": "new file",
          "change": "实现服务,注入 IConfiguration,加载 appsettings.json 规则,实现两级匹配逻辑(ProcessName + Keywords),路由到对应提取器"
        },
        {
          "file": "XhMonitor.Core/Services/Extractors/RegexExtractor.cs",
          "target": "new file",
          "change": "正则提取器,使用 Pattern 和 Group 提取命令行参数,应用 Format 模板,缓存编译后的 Regex 对象"
        },
        {
          "file": "XhMonitor.Core/Services/Extractors/DirectNameExtractor.cs",
          "target": "new file",
          "change": "直接名称提取器,直接返回配置的 DisplayName,不解析命令行"
        }
      ],
      "implementation": [
        "创建 IProcessNameResolver 接口,定义 Resolve(string processName, string commandLine) 方法",
        "创建 ProcessNameRule 模型类,字段: ProcessName(string), Keywords(string[]), Type(string: 'Regex'|'Direct'), Pattern(string?), Group(int?), Format(string?), DisplayName(string?)",
        "实现 ProcessNameResolver 服务,构造函数接受 IConfiguration 和 ILogger",
        "从 appsettings.json Monitor:ProcessNameRules 加载规则列表",
        "实现两级匹配逻辑: 1) ProcessName 精确匹配, 2) Keywords 任意匹配(如果配置了关键字)",
        "匹配优先级: 有关键字的规则优先,Keywords 为空数组的规则作为该进程名称的默认规则",
        "根据 rule.Type 路由到对应提取器: 'Regex' → RegexExtractor, 'Direct' → DirectNameExtractor",
        "RegexExtractor: 使用 Regex.Match() 提取捕获组,应用 string.Format() 格式化,缓存 Regex 对象",
        "DirectNameExtractor: 直接返回 rule.DisplayName",
        "线程安全: 提取器无状态,Regex 对象使用 ConcurrentDictionary 缓存",
        "失败处理: 捕获异常,记录 Debug 级别日志,回退到 'ProcessName: (no rule)' 格式"
      ],
      "reference": {
        "pattern": "Provider Pattern + Strategy Pattern",
        "files": [
          "XhMonitor.Core/Interfaces/IMetricProvider.cs",
          "XhMonitor.Service/Core/MetricProviderRegistry.cs",
          "XhMonitor.Service/Core/ProcessScanner.cs"
        ],
        "examples": "参考 IMetricProvider 的 DisplayName 模式和 MetricProviderRegistry 的责任链模式,ProcessScanner 的 Keywords 匹配逻辑"
      },
      "acceptance": [
        "IProcessNameResolver 接口定义完成",
        "ProcessNameRule 模型类包含所有必需字段",
        "ProcessNameResolver 服务实现两级匹配逻辑(ProcessName + Keywords)",
        "RegexExtractor 和 DirectNameExtractor 实现完成",
        "Regex 对象被缓存,线程安全",
        "失败时回退到 'ProcessName: (no rule)' 格式,仅 Debug 日志"
      ]
    },
    {
      "id": "T2",
      "title": "扩展数据模型添加 DisplayName 属性",
      "scope": "XhMonitor.Core/Models/, XhMonitor.Desktop/Models/, XhMonitor.Core/Entities/",
      "action": "Update",
      "description": "在 ProcessInfo 域模型、ProcessInfoDto 传输对象和 ProcessMetricRecord 实体中添加 DisplayName 属性。保持 ProcessInfo 不可变性,ProcessMetricRecord 需要数据库迁移。",
      "modification_points": [
        {
          "file": "XhMonitor.Core/Models/ProcessInfo.cs",
          "target": "properties:5-8",
          "change": "添加 public string? DisplayName { get; init; } 属性"
        },
        {
          "file": "XhMonitor.Desktop/Models/ProcessInfoDto.cs",
          "target": "properties:10-17",
          "change": "添加 [JsonPropertyName(\"displayName\")] public string DisplayName { get; set; } = string.Empty;"
        },
        {
          "file": "XhMonitor.Core/Entities/ProcessMetricRecord.cs",
          "target": "properties",
          "change": "添加 public string? DisplayName { get; set; } 属性"
        }
      ],
      "implementation": [
        "ProcessInfo 添加 DisplayName 属性,使用 init-only setter 保持不可变性",
        "ProcessInfoDto 添加 DisplayName 属性,JsonPropertyName 属性用于序列化",
        "ProcessMetricRecord 添加 DisplayName 列,nullable string 类型",
        "确保 DisplayName 在 ProcessInfo 中可为 null(string?),表示可选值",
        "ProcessInfoDto DisplayName 默认为空字符串,向后兼容"
      ],
      "reference": {
        "pattern": "DTO Pattern + Entity Pattern",
        "files": [
          "XhMonitor.Core/Models/ProcessInfo.cs",
          "XhMonitor.Desktop/Models/ProcessInfoDto.cs",
          "XhMonitor.Core/Entities/ProcessMetricRecord.cs"
        ],
        "examples": "遵循现有属性模式:ProcessInfo 使用 required init,DTO 使用 JsonPropertyName,Entity 使用可空属性"
      },
      "acceptance": [
        "ProcessInfo 有 DisplayName 属性,init-only setter",
        "ProcessInfoDto 有 DisplayName 属性,JsonPropertyName 特性",
        "ProcessMetricRecord 有 DisplayName 列,nullable string",
        "现有代码编译通过(向后兼容)",
        "DisplayName 在 SignalR 传输中正确序列化"
      ]
    },
    {
      "id": "T3",
      "title": "集成 ProcessNameResolver 到 ProcessScanner",
      "scope": "XhMonitor.Service/Core/, XhMonitor.Service/",
      "action": "Update",
      "description": "在 ProcessScanner 构造函数注入 IProcessNameResolver,在 ProcessSingleProcess() 方法中调用 Resolve() 设置 DisplayName。在 Program.cs 注册服务。",
      "modification_points": [
        {
          "file": "XhMonitor.Service/Core/ProcessScanner.cs",
          "target": "constructor:13-21",
          "change": "添加 IProcessNameResolver 参数到构造函数"
        },
        {
          "file": "XhMonitor.Service/Core/ProcessScanner.cs",
          "target": "ProcessSingleProcess:75-107",
          "change": "在 line 75 后调用 _nameResolver.Resolve(),在 ProcessInfo 创建时设置 DisplayName"
        },
        {
          "file": "XhMonitor.Service/Program.cs",
          "target": "service registration",
          "change": "注册 IProcessNameResolver 为 Singleton"
        }
      ],
      "implementation": [
        "在 ProcessScanner 添加 IProcessNameResolver _nameResolver 字段",
        "更新构造函数接受 IProcessNameResolver 并赋值给字段",
        "在 line 75 (commandLine 提取后)调用: string displayName = _nameResolver.Resolve(processName, commandLine ?? string.Empty);",
        "更新 ProcessInfo 创建(lines 101-107)包含 DisplayName = displayName",
        "在 Program.cs 注册: builder.Services.AddSingleton<IProcessNameResolver, ProcessNameResolver>();",
        "确保 resolver 调用在 try-catch 内,防止进程扫描失败"
      ],
      "reference": {
        "pattern": "Dependency Injection",
        "files": [
          "XhMonitor.Service/Core/ProcessScanner.cs",
          "XhMonitor.Service/Program.cs"
        ],
        "examples": "遵循现有 DI 模式,ProcessScanner 构造函数注入 ILogger 和 IConfiguration"
      },
      "acceptance": [
        "ProcessScanner 构造函数接受 IProcessNameResolver",
        "Resolver 在 ProcessSingleProcess() 中 CommandLine 提取后调用",
        "DisplayName 在 ProcessInfo 创建时设置",
        "服务在 Program.cs DI 容器中注册",
        "即使名称解析失败,进程扫描也继续"
      ],
      "depends_on": ["T1", "T2"]
    },
    {
      "id": "T4",
      "title": "更新 UI ViewModel 显示友好名称",
      "scope": "XhMonitor.Desktop/ViewModels/",
      "action": "Update",
      "description": "修改 FloatingWindowViewModel.ProcessRowViewModel 使用 DisplayName 而非 ProcessName 显示。更新 UpdateFrom() 方法处理 DTO 的 DisplayName,实现回退逻辑。",
      "modification_points": [
        {
          "file": "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs",
          "target": "ProcessRowViewModel:370-429",
          "change": "添加 DisplayName 属性,更新 UpdateFrom() 从 DTO 设置 DisplayName"
        },
        {
          "file": "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs",
          "target": "UpdateFrom:411-419",
          "change": "添加 DisplayName = dto.DisplayName ?? dto.ProcessName; 处理回退"
        }
      ],
      "implementation": [
        "在 ProcessRowViewModel 添加 DisplayName 属性,使用 INotifyPropertyChanged 模式",
        "更新 UpdateFrom() 方法从 DTO 设置 DisplayName,回退到 ProcessName",
        "实现回退逻辑: DisplayName = !string.IsNullOrEmpty(dto.DisplayName) ? dto.DisplayName : dto.ProcessName;",
        "保留 ProcessName 属性供内部使用(过滤、日志)",
        "UI 绑定将在 T5 更新为使用 DisplayName"
      ],
      "reference": {
        "pattern": "MVVM Pattern",
        "files": [
          "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs"
        ],
        "examples": "遵循现有 ProcessName 属性模式(lines 374-379),使用 SetField 辅助方法进行变更通知"
      },
      "acceptance": [
        "ProcessRowViewModel 有 DisplayName 属性,实现 INotifyPropertyChanged",
        "UpdateFrom() 从 DTO 设置 DisplayName,回退到 ProcessName",
        "属性变更通知正常工作",
        "原始 ProcessName 属性保留供内部使用"
      ],
      "depends_on": ["T2"]
    },
    {
      "id": "T5",
      "title": "配置提取规则和更新 UI 绑定",
      "scope": "XhMonitor.Service/, XhMonitor.Desktop/",
      "action": "Configure",
      "description": "在 appsettings.json 添加 ProcessNameRules 配置节,包含两种类型的规则示例(Regex 和 Direct)。更新 FloatingWindow.xaml 绑定显示 DisplayName。",
      "modification_points": [
        {
          "file": "XhMonitor.Service/appsettings.json",
          "target": "Monitor section:13-16",
          "change": "添加 ProcessNameRules 数组,包含 Regex 类型和 Direct 类型的规则示例"
        },
        {
          "file": "XhMonitor.Desktop/Views/FloatingWindow.xaml",
          "target": "ProcessName bindings",
          "change": "更新 TextBlock 绑定从 ProcessName 到 DisplayName"
        }
      ],
      "implementation": [
        "在 appsettings.json 添加 Monitor:ProcessNameRules 节",
        "Regex 类型规则示例: { \"ProcessName\": \"llama-server\", \"Keywords\": [\"llama\", \"model\"], \"Type\": \"Regex\", \"Pattern\": \"--model\\\\s+([^\\\\s]+)\", \"Group\": 1, \"Format\": \"llama-server: {0}\" }",
        "Direct 类型规则示例: { \"ProcessName\": \"chrome\", \"Keywords\": [], \"Type\": \"Direct\", \"DisplayName\": \"Google Chrome\" }",
        "包含多个 python 规则示例,使用不同 Keywords 区分(fastapi, django, 空数组)",
        "包含 node 规则示例,使用 Keywords 区分(express, server)",
        "更新 FloatingWindow.xaml TextBlock 绑定使用 DisplayName 属性",
        "测试配置加载在 ProcessNameResolver 构造函数",
        "验证 UI 显示配置进程的友好名称"
      ],
      "reference": {
        "pattern": "Configuration Pattern",
        "files": [
          "XhMonitor.Service/appsettings.json"
        ],
        "examples": "遵循现有 Monitor:Keywords 模式(lines 13-16),使用嵌套数组结构"
      },
      "acceptance": [
        "appsettings.json 有 ProcessNameRules 节,包含 5+ 规则(Regex 和 Direct 类型)",
        "配置包含 Keywords 字段,实现两级匹配",
        "配置被 ProcessNameResolver 正确加载",
        "UI 显示匹配规则的进程的 DisplayName",
        "UI 对无规则的进程回退到 ProcessName"
      ],
      "depends_on": ["T4"]
    },
    {
      "id": "T6",
      "title": "数据库迁移添加 DisplayName 列",
      "scope": "XhMonitor.Core/Entities/, XhMonitor.Service/",
      "action": "Create",
      "description": "创建 EF Core 迁移添加 DisplayName 列到 ProcessMetricRecord 表。更新 Repository 保存 DisplayName。测试迁移和数据一致性。",
      "modification_points": [
        {
          "file": "XhMonitor.Service/Migrations/",
          "target": "new migration file",
          "change": "创建迁移添加 DisplayName 列(nullable string)"
        },
        {
          "file": "XhMonitor.Service/Repositories/MetricRepository.cs",
          "target": "SaveMetricsAsync",
          "change": "更新保存逻辑包含 DisplayName 字段"
        }
      ],
      "implementation": [
        "运行 dotnet ef migrations add AddDisplayNameToProcessMetricRecord",
        "验证迁移文件正确添加 DisplayName 列(nullable string, no default)",
        "更新 MetricRepository.SaveMetricsAsync() 从 ProcessInfo 保存 DisplayName",
        "测试迁移:应用到测试数据库,验证列添加成功",
        "测试数据一致性:保存带 DisplayName 的记录,查询验证",
        "测试向后兼容:现有记录 DisplayName 为 null,不影响查询"
      ],
      "reference": {
        "pattern": "EF Core Migration",
        "files": [
          "XhMonitor.Service/Migrations/"
        ],
        "examples": "参考现有迁移文件结构和命名约定"
      },
      "acceptance": [
        "迁移文件创建成功,添加 DisplayName 列",
        "MetricRepository 保存 DisplayName 到数据库",
        "迁移应用到数据库成功",
        "现有数据不受影响(DisplayName 为 null)",
        "新记录正确保存 DisplayName"
      ],
      "depends_on": ["T2", "T3"]
    },
    {
      "id": "T7",
      "title": "创建 xUnit 测试项目和测试固件",
      "scope": "XhMonitor.Tests/",
      "action": "Create",
      "description": "创建 xUnit 测试项目,添加 50+ 真实命令行示例的测试固件。测试两种提取器、两级匹配逻辑、失败处理、线程安全。",
      "modification_points": [
        {
          "file": "XhMonitor.Tests/XhMonitor.Tests.csproj",
          "target": "new file",
          "change": "创建测试项目,引用 xUnit, FluentAssertions, Moq"
        },
        {
          "file": "XhMonitor.Tests/Fixtures/CommandLineFixtures.cs",
          "target": "new file",
          "change": "定义 50+ 真实命令行示例和期望的 DisplayName"
        },
        {
          "file": "XhMonitor.Tests/Services/ProcessNameResolverTests.cs",
          "target": "new file",
          "change": "测试 ProcessNameResolver 的两级匹配逻辑和所有边缘情况"
        },
        {
          "file": "XhMonitor.Tests/Services/ExtractorTests.cs",
          "target": "new file",
          "change": "单独测试两种提取器(RegexExtractor, DirectNameExtractor)"
        }
      ],
      "implementation": [
        "创建 XhMonitor.Tests 项目,添加 NuGet 包: xUnit (2.6+), FluentAssertions (6.12+), Moq (4.20+)",
        "创建 CommandLineFixtures.cs,定义测试数据类: (ProcessName, Keywords, CommandLine, ExpectedDisplayName)",
        "包含 50+ 场景: llamacpp (--model, -m), python (fastapi, django, 通用), node (express, 通用), java (-jar), dotnet (run), chrome (Direct 类型), 特殊字符, Unicode, 长路径, 空 CommandLine",
        "创建 ProcessNameResolverTests.cs,使用 [Theory] 和 [MemberData] 进行数据驱动测试",
        "测试两级匹配逻辑: ProcessName 精确匹配 + Keywords 任意匹配",
        "测试匹配优先级: 有关键字的规则优先于无关键字的规则",
        "测试两种提取器: Regex 类型和 Direct 类型",
        "测试失败处理: 格式错误的 CommandLine,正则超时,异常捕获",
        "测试线程安全: 并行执行 Resolve(),验证无竞态条件",
        "测试回退格式: 'ProcessName: (no rule)'"
      ],
      "reference": {
        "pattern": "xUnit Data-Driven Testing",
        "files": [
          "SqliteTest/Program.cs"
        ],
        "examples": "参考 SqliteTest 的测试模式,但使用 xUnit 框架和断言"
      },
      "acceptance": [
        "XhMonitor.Tests 项目创建,包含 xUnit, FluentAssertions, Moq",
        "CommandLineFixtures.cs 包含 50+ 测试场景,包含 Keywords 字段",
        "ProcessNameResolverTests.cs 覆盖两级匹配逻辑和所有边缘情况",
        "ExtractorTests.cs 覆盖两种提取器的所有场景",
        "所有测试通过,代码覆盖率 > 80%",
        "测试可在 CI/CD 管道中运行"
      ],
      "depends_on": ["T1"]
    }
  ],
  "focus_paths": [
    "XhMonitor.Core/Interfaces/IProcessNameResolver.cs",
    "XhMonitor.Core/Models/ProcessNameRule.cs",
    "XhMonitor.Core/Services/ProcessNameResolver.cs",
    "XhMonitor.Core/Services/Extractors/RegexExtractor.cs",
    "XhMonitor.Core/Services/Extractors/DirectNameExtractor.cs",
    "XhMonitor.Core/Models/ProcessInfo.cs",
    "XhMonitor.Desktop/Models/ProcessInfoDto.cs",
    "XhMonitor.Core/Entities/ProcessMetricRecord.cs",
    "XhMonitor.Service/Core/ProcessScanner.cs",
    "XhMonitor.Service/Program.cs",
    "XhMonitor.Desktop/ViewModels/FloatingWindowViewModel.cs",
    "XhMonitor.Service/appsettings.json",
    "XhMonitor.Desktop/Views/FloatingWindow.xaml",
    "XhMonitor.Service/Migrations/",
    "XhMonitor.Tests/"
  ],
  "estimated_time": "3-4 hours",
  "recommended_execution": "Agent",
  "complexity": "Medium",
  "_metadata": {
    "timestamp": "2026-01-13T00:00:00Z",
    "source": "direct-planning-final",
    "planning_mode": "clarification-based-with-user-feedback",
    "exploration_angles": ["patterns", "integration-points", "testing"],
    "clarification_rounds": 3,
    "total_clarifications": 12,
    "user_feedback_rounds": 2,
    "duration_seconds": 900,
    "changes_from_revised": [
      "T1 重大调整: 移除内置策略类(LlamaCpp, Python, NodeJs),改为两种提取器(RegexExtractor, DirectNameExtractor)",
      "T1 新增: ProcessNameRule 模型类,包含 Keywords 字段",
      "T1 新增: 两级匹配逻辑(ProcessName + Keywords),与现有进程发现逻辑一致",
      "T5 调整: 配置示例包含 Keywords 字段和两种类型(Regex, Direct)",
      "T7 调整: 测试覆盖两级匹配逻辑和两种提取器"
    ],
    "changes_from_original": [
      "添加 T6: 数据库迁移任务(用户选择持久化 DisplayName)",
      "添加 T7: xUnit 测试项目任务(用户选择正式测试框架)",
      "T1: 从内置策略改为配置驱动的两种提取器,失败格式改为 'ProcessName: (no rule)'",
      "T1: 添加两级匹配逻辑(ProcessName + Keywords)",
      "T3: 集成点确认为 ProcessScanner(Option A)",
      "T5: 配置节包含 Keywords 字段和两种类型示例",
      "所有任务: 错误处理改为 Debug 级别日志"
    ]
  }
}
