{
  "goal": "Optimize XhMonitor memory usage to acceptable levels (< 300MB for Service)",
  "analysis": {
    "rootCause": "Massive memory allocation at startup due to iterating thousands of GPU Engine performance counter instances to calculate 'System Total GPU/VRAM Usage'.",
    "secondaryCause": "Memory leak in GpuMetricProvider where process-specific counters are never disposed after process exit.",
    "discardedTheories": [
      "SignalR broadcast size is too large (proven false for <50 processes)",
      "EF Core tracking overhead (minor impact compared to GPU counters)",
      "Process scanning leak (code uses SafeHandles correctly)"
    ]
  },
  "tasks": [
    {
      "id": "fix-gpu-memory-explosion",
      "description": "Disable system-wide GPU/VRAM counter iteration in GpuMetricProvider and SystemMetricProvider to stop startup memory explosion.",
      "status": "pending",
      "priority": "critical",
      "files": [
        "XhMonitor.Core/Providers/GpuMetricProvider.cs",
        "XhMonitor.Core/Providers/SystemMetricProvider.cs"
      ]
    },
    {
      "id": "fix-gpu-handle-leak",
      "description": "Implement cleanup logic in GpuMetricProvider to dispose PerformanceCounters for processes that are no longer running (60s timeout).",
      "status": "pending",
      "priority": "high",
      "files": [
        "XhMonitor.Core/Providers/GpuMetricProvider.cs"
      ]
    },
    {
      "id": "optimize-ef-core",
      "description": "Add ChangeTracker.Clear() after SaveChangesAsync to prevent object accumulation during long runs.",
      "status": "pending",
      "priority": "medium",
      "files": [
        "XhMonitor.Service/Data/Repositories/MetricRepository.cs"
      ]
    }
  ]
}