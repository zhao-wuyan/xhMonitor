{"id":"SOL-ISS-1769239097521-3-n9w4","description":"Refactor to Generic Host pattern with proper separation of concerns","approach":"Current App.xaml.cs mixes UI logic, service orchestration, and composition root responsibilities. This violates separation of concerns and makes testing difficult. Solution: Introduce Generic Host pattern with HostApplicationLifetime for lifecycle management, create dedicated HostedService for backend/web service orchestration, move window management to separate service, and use proper async startup/shutdown with CancellationToken support.","analysis":{"risk":"medium","impact":"high","complexity":"medium"},"score":0.85,"tasks":[{"id":"T1","title":"Add Generic Host package references","scope":"XhMonitor.Desktop/XhMonitor.Desktop.csproj","action":"Update","description":"Add Microsoft.Extensions.Hosting package to enable Generic Host pattern","modification_points":["XhMonitor.Desktop.csproj ItemGroup with PackageReferences"],"implementation":["Add package reference: <PackageReference Include=\"Microsoft.Extensions.Hosting\" Version=\"8.*\" />"],"test":{"unit":[],"commands":["dotnet restore XhMonitor.Desktop/XhMonitor.Desktop.csproj","dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["Microsoft.Extensions.Hosting package added","Package version 8.* compatible with net8.0","Restore succeeds without conflicts"],"verification":["dotnet restore succeeds","dotnet build succeeds"]},"commit":{"type":"chore","scope":"desktop","message_template":"chore(desktop): add Generic Host package reference"},"depends_on":[],"priority":1},{"id":"T2","title":"Create ApplicationHostedService for service orchestration","scope":"XhMonitor.Desktop/Services","action":"Create","description":"Create BackgroundService implementation to manage backend and web service lifecycle with proper async/await and CancellationToken support","modification_points":["XhMonitor.Desktop/Services/ApplicationHostedService.cs (new file)"],"implementation":["Create class ApplicationHostedService : BackgroundService","Inject IBackendServerService, IWebServerService via constructor","Override ExecuteAsync(CancellationToken): await both services' StartAsync()","Override StopAsync(CancellationToken): await both services' StopAsync() with timeout","Use CancellationToken for graceful shutdown","Add error handling and logging"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["ApplicationHostedService implements BackgroundService","Services start asynchronously in ExecuteAsync","Services stop gracefully in StopAsync with timeout","CancellationToken properly propagated"],"verification":["Build succeeds","No compilation errors","Service lifecycle methods properly implemented"]},"commit":{"type":"feat","scope":"desktop/services","message_template":"feat(desktop/services): add ApplicationHostedService for service orchestration"},"depends_on":["T1"],"priority":2},{"id":"T3","title":"Create WindowManagementService for UI lifecycle","scope":"XhMonitor.Desktop/Services","action":"Create","description":"Extract window creation and management logic into dedicated service to separate UI concerns from application lifecycle","modification_points":["XhMonitor.Desktop/Services/WindowManagementService.cs (new file)","XhMonitor.Desktop/Services/IWindowManagementService.cs (new file)"],"implementation":["Create IWindowManagementService interface with methods: InitializeMainWindow(), ShowMainWindow(), HideMainWindow(), CloseMainWindow()","Create WindowManagementService implementation","Move FloatingWindow creation and event subscription logic from App.xaml.cs","Inject ITrayIconService and wire up window callbacks","Store FloatingWindow reference and manage its lifecycle"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["IWindowManagementService interface defined","WindowManagementService implements interface","Window creation logic extracted from App.xaml.cs","Event subscriptions properly managed"],"verification":["Build succeeds","No compilation errors","Service properly encapsulates window management"]},"commit":{"type":"refactor","scope":"desktop/services","message_template":"refactor(desktop/services): extract window management to dedicated service"},"depends_on":[],"priority":2},{"id":"T4","title":"Refactor App.xaml.cs to use Generic Host","scope":"XhMonitor.Desktop/App.xaml.cs","action":"Update","description":"Replace manual service orchestration with Generic Host, configure services via HostBuilder, and use HostApplicationLifetime for lifecycle management","modification_points":["App.xaml.cs entire file (lines 12-228)"],"implementation":["Add private IHost? _host field","In OnStartup: create Host.CreateDefaultBuilder().ConfigureServices() to register all services","Register ApplicationHostedService as HostedService","Register WindowManagementService, BackendServerService, WebServerService, TrayIconService as singletons","Build host: _host = builder.Build()","Start host: await _host.StartAsync()","Get WindowManagementService and initialize main window","Remove manual service instantiation and startup code","In OnExit: await _host?.StopAsync() then _host?.Dispose()","Remove OnSessionEnding handler (handled by HostedService)","Keep UI callback methods (ToggleFloatingWindow, OpenAboutWindow, etc.) but delegate to WindowManagementService"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["App.xaml.cs uses Generic Host pattern","All services registered via DI container","ApplicationHostedService manages service lifecycle","OnStartup and OnExit use proper async/await","No manual service orchestration remains"],"verification":["Build succeeds","Application starts without errors","Services start and stop correctly","Window displays properly"]},"commit":{"type":"refactor","scope":"desktop","message_template":"refactor(desktop): adopt Generic Host pattern for application lifecycle"},"depends_on":["T2","T3"],"priority":3},{"id":"T5","title":"Update service interfaces for CancellationToken support","scope":"XhMonitor.Desktop/Services","action":"Update","description":"Add CancellationToken parameters to IBackendServerService and IWebServerService methods to support graceful cancellation","modification_points":["IBackendServerService.cs","IWebServerService.cs","BackendServerService.cs","WebServerService.cs"],"implementation":["Update interface methods: Task StartAsync(CancellationToken cancellationToken = default)","Update interface methods: Task StopAsync(CancellationToken cancellationToken = default)","Update implementations to accept and use CancellationToken","Pass CancellationToken to async operations (Task.Delay, WaitAsync, etc.)","Ensure cancellation is properly handled in long-running operations"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["Service interfaces include CancellationToken parameters","Implementations properly use CancellationToken","Cancellation propagates through async operations","Graceful shutdown supported"],"verification":["Build succeeds","No compilation errors","Services respond to cancellation requests"]},"commit":{"type":"refactor","scope":"desktop/services","message_template":"refactor(desktop/services): add CancellationToken support for graceful shutdown"},"depends_on":["T2"],"priority":2}],"is_bound":true,"bound_at":"2026-01-24T07:39:41.917Z"}
