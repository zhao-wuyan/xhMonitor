{"id":"SOL-ISS-1769239097521-2-b3k8","description":"Adopt IOptions pattern for configuration management in Worker and related services to improve testability and reduce coupling","approach":"Replace direct IConfiguration injection with strongly-typed IOptions<T> pattern. Create MonitorSettings and DatabaseSettings classes to encapsulate configuration sections. This follows .NET best practices and enables configuration validation, change notifications, and easier unit testing. The solution maintains backward compatibility while improving code quality.","analysis":{"risk":"low","impact":"medium","complexity":"medium"},"score":0.9,"tasks":[{"id":"T1","title":"Create MonitorSettings configuration class","scope":"XhMonitor.Service/Configuration","action":"Create","description":"Create strongly-typed configuration class for Monitor section in appsettings.json","modification_points":["XhMonitor.Service/Configuration/MonitorSettings.cs (new file)"],"implementation":["Create new file XhMonitor.Service/Configuration/MonitorSettings.cs","Define public class MonitorSettings with properties: IntervalSeconds (int, default 5), SystemUsageIntervalSeconds (int, default 1)","Add data annotations for validation: [Range(1, 3600)] for both properties","Add XML documentation comments explaining each property","Ensure namespace matches XhMonitor.Service.Configuration"],"test":{"unit":["Verify MonitorSettings can be instantiated","Verify default values are applied","Verify validation attributes work correctly","Test configuration binding from IConfiguration"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~MonitorSettings"]},"acceptance":{"criteria":["MonitorSettings class created in Configuration folder","Properties match appsettings.json Monitor section","Validation attributes applied","XML documentation added","No compilation errors"],"verification":["Build project successfully","Configuration binding test passes","Validation test passes"]},"commit":{"type":"feat","scope":"service/config","message_template":"feat(service/config): add MonitorSettings configuration class\n\nCreate strongly-typed configuration class for Monitor section.\nIncludes validation attributes and default values matching\nappsettings.json. Part of IOptions pattern adoption."},"depends_on":[],"priority":1},{"id":"T2","title":"Create DatabaseSettings configuration class","scope":"XhMonitor.Service/Configuration","action":"Create","description":"Create strongly-typed configuration class for Database section in appsettings.json","modification_points":["XhMonitor.Service/Configuration/DatabaseSettings.cs (new file)"],"implementation":["Create new file XhMonitor.Service/Configuration/DatabaseSettings.cs","Define public class DatabaseSettings with properties: RetentionDays (int, default 30), CleanupIntervalHours (int, default 24)","Add data annotations: [Range(1, 365)] for RetentionDays, [Range(1, 168)] for CleanupIntervalHours","Add XML documentation comments","Ensure namespace matches XhMonitor.Service.Configuration"],"test":{"unit":["Verify DatabaseSettings can be instantiated","Verify default values are applied","Verify validation attributes work correctly","Test configuration binding"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~DatabaseSettings"]},"acceptance":{"criteria":["DatabaseSettings class created","Properties match appsettings.json Database section","Validation attributes applied","XML documentation added","No compilation errors"],"verification":["Build project successfully","Configuration binding test passes","Validation test passes"]},"commit":{"type":"feat","scope":"service/config","message_template":"feat(service/config): add DatabaseSettings configuration class\n\nCreate strongly-typed configuration class for Database section.\nIncludes validation for retention and cleanup intervals."},"depends_on":[],"priority":1},{"id":"T3","title":"Register configuration classes in Program.cs","scope":"XhMonitor.Service","action":"Update","description":"Register MonitorSettings and DatabaseSettings with DI container using IOptions pattern","modification_points":["XhMonitor.Service/Program.cs:116-120"],"implementation":["After line 90 (builder.Host.UseSerilog()), add configuration registration","Add: builder.Services.Configure<MonitorSettings>(builder.Configuration.GetSection(\"Monitor\"));","Add: builder.Services.Configure<DatabaseSettings>(builder.Configuration.GetSection(\"Database\"));","Add: builder.Services.AddOptions<MonitorSettings>().ValidateDataAnnotations().ValidateOnStart();","Add: builder.Services.AddOptions<DatabaseSettings>().ValidateDataAnnotations().ValidateOnStart();"],"test":{"unit":["Verify configuration classes are registered in DI container","Verify validation is triggered on startup","Verify invalid configuration throws on startup","Test configuration can be resolved via IOptions<T>"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~Configuration"]},"acceptance":{"criteria":["MonitorSettings registered with Configure<T>","DatabaseSettings registered with Configure<T>","Validation enabled with ValidateDataAnnotations","ValidateOnStart ensures early failure detection","No compilation errors"],"verification":["Application starts successfully with valid config","Application fails fast with invalid config","DI resolution test passes"]},"commit":{"type":"feat","scope":"service/di","message_template":"feat(service/di): register configuration classes with IOptions\n\nRegister MonitorSettings and DatabaseSettings in DI container.\nEnable validation with ValidateDataAnnotations and ValidateOnStart\nfor early detection of configuration errors."},"depends_on":["T1","T2"],"priority":2},{"id":"T4","title":"Update Worker to use IOptions<MonitorSettings>","scope":"XhMonitor.Service","action":"Update","description":"Replace IConfiguration injection in Worker with IOptions<MonitorSettings>","modification_points":["XhMonitor.Service/Worker.cs:29-46"],"implementation":["Replace IConfiguration config parameter with IOptions<MonitorSettings> monitorOptions in constructor (line 36)","Update field initialization: _processIntervalSeconds = Math.Max(1, monitorOptions.Value.IntervalSeconds);","Update field initialization: _systemIntervalSeconds = Math.Max(1, monitorOptions.Value.SystemUsageIntervalSeconds);","Remove Math.Max validation since it's now handled by [Range] attribute","Add null check: ArgumentNullException.ThrowIfNull(monitorOptions);"],"test":{"unit":["Update WorkerTests.cs to use IOptions<MonitorSettings> instead of IConfiguration","Verify Worker can be instantiated with IOptions","Verify interval values are correctly read from options","Test with invalid configuration values"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~WorkerTests"]},"acceptance":{"criteria":["IConfiguration parameter replaced with IOptions<MonitorSettings>","Interval values read from monitorOptions.Value","Math.Max validation removed (handled by [Range])","Null check added for monitorOptions","All existing tests updated and passing"],"verification":["Build project successfully","All Worker tests pass","Integration test confirms correct interval behavior"]},"commit":{"type":"refactor","scope":"service/worker","message_template":"refactor(service/worker): adopt IOptions pattern for configuration\n\nReplace IConfiguration injection with IOptions<MonitorSettings>.\nRemoves direct coupling to configuration keys and enables\nbetter testability. Validation now handled by data annotations."},"depends_on":["T3"],"priority":3},{"id":"T5","title":"Update DatabaseCleanupWorker to use IOptions<DatabaseSettings>","scope":"XhMonitor.Service/Workers","action":"Update","description":"Replace IConfiguration injection in DatabaseCleanupWorker with IOptions<DatabaseSettings>","modification_points":["XhMonitor.Service/Workers/DatabaseCleanupWorker.cs:11-28"],"implementation":["Replace IConfiguration _configuration field with IOptions<DatabaseSettings> _databaseOptions","Update constructor to accept IOptions<DatabaseSettings> databaseOptions parameter","Update ExecuteAsync method: var intervalHours = _databaseOptions.Value.CleanupIntervalHours;","Update ExecuteAsync method: var retentionDays = _databaseOptions.Value.RetentionDays;","Remove GetValue calls and default value parameters","Add null check: ArgumentNullException.ThrowIfNull(databaseOptions);"],"test":{"unit":["Create test for DatabaseCleanupWorker with IOptions<DatabaseSettings>","Verify worker reads configuration from options","Verify cleanup runs with correct intervals","Test with various configuration values"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~DatabaseCleanupWorker"]},"acceptance":{"criteria":["IConfiguration replaced with IOptions<DatabaseSettings>","Configuration values read from _databaseOptions.Value","GetValue calls removed","Null check added","Tests updated and passing"],"verification":["Build project successfully","DatabaseCleanupWorker tests pass","Integration test confirms cleanup behavior"]},"commit":{"type":"refactor","scope":"service/workers","message_template":"refactor(service/workers): adopt IOptions pattern in DatabaseCleanupWorker\n\nReplace IConfiguration with IOptions<DatabaseSettings>.\nImproves testability and removes coupling to configuration keys."},"depends_on":["T3"],"priority":3},{"id":"T6","title":"Update LibreHardwareManager registration to use IOptions","scope":"XhMonitor.Service","action":"Update","description":"Update LibreHardwareManager factory registration to use IOptions<MonitorSettings> instead of IConfiguration","modification_points":["XhMonitor.Service/Program.cs:109-115"],"implementation":["Update factory lambda to accept IOptions<MonitorSettings> instead of IConfiguration","Change: var monitorOptions = sp.GetRequiredService<IOptions<MonitorSettings>>();","Change: var systemIntervalSeconds = Math.Max(1, monitorOptions.Value.SystemUsageIntervalSeconds);","Keep Math.Max since LibreHardwareManager is external and needs defensive validation","Update comment to explain why Math.Max is still needed"],"test":{"unit":["Verify LibreHardwareManager can be resolved from DI container","Verify correct interval is passed to constructor","Test with various configuration values"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~LibreHardwareManager"]},"acceptance":{"criteria":["Factory uses IOptions<MonitorSettings> instead of IConfiguration","SystemUsageIntervalSeconds read from options","Math.Max validation retained for external dependency","Comment explains validation strategy","No compilation errors"],"verification":["Build project successfully","LibreHardwareManager resolves correctly","Integration test confirms correct interval"]},"commit":{"type":"refactor","scope":"service/di","message_template":"refactor(service/di): use IOptions in LibreHardwareManager factory\n\nUpdate factory registration to use IOptions<MonitorSettings>.\nRetains defensive Math.Max validation for external dependency."},"depends_on":["T3"],"priority":4}],"is_bound":true,"bound_at":"2026-01-24T07:42:32.834Z"}
