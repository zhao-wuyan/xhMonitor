{"id":"SOL-DSC-20260119-150946-011-k7m2","description":"Refactor SettingsViewModel to use IHttpClientFactory for proper HttpClient lifecycle management, preventing socket exhaustion","approach":"Introduce IHttpClientFactory via dependency injection in XhMonitor.Desktop, refactor SettingsViewModel to accept HttpClient through constructor injection, and update SettingsWindow instantiation to use DI container","analysis":{"risk":"low","impact":"low","complexity":"low"},"score":0.92,"tasks":[{"id":"T1","title":"Register IHttpClientFactory in Desktop DI Container","scope":"XhMonitor.Desktop/App.xaml.cs","action":"Update","description":"Add IHttpClientFactory registration to the existing ServiceCollection in App.xaml.cs OnStartup method","modification_points":["XhMonitor.Desktop/App.xaml.cs:25-30"],"implementation":["Open App.xaml.cs and locate the OnStartup method where ServiceCollection is configured","After line 28 (services.AddSingleton<ITrayIconService, TrayIconService>()), add: services.AddHttpClient()","This registers the default IHttpClientFactory with proper HttpClient pooling and lifecycle management","Verify the Microsoft.Extensions.Http package is available (it's included via Microsoft.Extensions.DependencyInjection)"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["IHttpClientFactory is registered in DI container","Build succeeds without errors","No breaking changes to existing service registrations"],"verification":["Verify services.AddHttpClient() is called in App.xaml.cs","Run dotnet build and confirm no compilation errors","Check that existing services (BackendServerService, WebServerService, TrayIconService) still resolve correctly"]},"commit":{"type":"refactor","scope":"desktop/di","message_template":"refactor(desktop/di): register IHttpClientFactory in DI container\n\nAdd IHttpClientFactory registration to prevent socket exhaustion from\nper-request HttpClient instantiation. Prepares for SettingsViewModel\nrefactoring to use injected HttpClient.\n\nRelated: DSC-20260119-150946-011"},"depends_on":[],"priority":1},{"id":"T2","title":"Refactor SettingsViewModel to Accept HttpClient via Constructor","scope":"XhMonitor.Desktop/ViewModels/SettingsViewModel.cs","action":"Update","description":"Replace new HttpClient() instantiation with constructor-injected HttpClient parameter","modification_points":["XhMonitor.Desktop/ViewModels/SettingsViewModel.cs:33-36"],"implementation":["Open SettingsViewModel.cs","Change constructor signature from 'public SettingsViewModel()' to 'public SettingsViewModel(HttpClient httpClient)'","Replace line 35 '_httpClient = new HttpClient();' with '_httpClient = httpClient;'","Remove the parameterless constructor entirely","Add XML documentation comment: /// <param name=\"httpClient\">HttpClient instance from IHttpClientFactory</param>","Ensure the private readonly HttpClient _httpClient field remains unchanged (line 12)"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["SettingsViewModel constructor accepts HttpClient parameter","No new HttpClient() instantiation in SettingsViewModel","Existing LoadSettingsAsync and SaveSettingsAsync methods use injected _httpClient","Build succeeds without errors"],"verification":["Verify constructor signature: public SettingsViewModel(HttpClient httpClient)","Confirm _httpClient = httpClient; assignment in constructor","Verify no 'new HttpClient()' exists in SettingsViewModel.cs","Run dotnet build and confirm compilation success"]},"commit":{"type":"refactor","scope":"desktop/viewmodel","message_template":"refactor(desktop/viewmodel): inject HttpClient into SettingsViewModel\n\nReplace per-instance HttpClient instantiation with constructor injection\nto leverage IHttpClientFactory pooling. Prevents socket exhaustion from\nrepeated HttpClient creation.\n\nRelated: DSC-20260119-150946-011"},"depends_on":["T1"],"priority":2},{"id":"T3","title":"Register SettingsViewModel in DI Container and Update Instantiation","scope":"XhMonitor.Desktop","action":"Update","description":"Register SettingsViewModel as transient service and update SettingsWindow to resolve it from DI container instead of XAML instantiation","modification_points":["XhMonitor.Desktop/App.xaml.cs:25-30","XhMonitor.Desktop/Windows/SettingsWindow.xaml:12-14","XhMonitor.Desktop/Windows/SettingsWindow.xaml.cs:11-14","XhMonitor.Desktop/App.xaml.cs:98-114"],"implementation":["Step 1: Register SettingsViewModel in App.xaml.cs","Open App.xaml.cs, locate OnStartup method","After services.AddHttpClient(), add: services.AddTransient<SettingsViewModel>()","Use Transient lifetime since SettingsViewModel is created per-window and doesn't hold state between instances","Step 2: Remove XAML DataContext instantiation","Open SettingsWindow.xaml","Remove lines 12-14 (Window.DataContext with vm:SettingsViewModel instantiation)","The DataContext will be set programmatically in code-behind","Step 3: Update SettingsWindow.xaml.cs constructor","Open SettingsWindow.xaml.cs","Change constructor to accept SettingsViewModel: public SettingsWindow(SettingsViewModel viewModel)","Replace line 14 '_viewModel = (SettingsViewModel)DataContext;' with '_viewModel = viewModel;'","Add line after InitializeComponent(): DataContext = _viewModel;","Step 4: Update SettingsWindow instantiation in App.xaml.cs","Locate OpenAboutWindow method (line 98) as reference for window creation pattern","Find where SettingsWindow is instantiated (search for 'new SettingsWindow()')","Replace 'new SettingsWindow()' with: _serviceProvider.GetRequiredService<SettingsViewModel>() then pass to constructor","Example: var settingsWindow = new SettingsWindow(_serviceProvider.GetRequiredService<SettingsViewModel>());"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj","dotnet run --project XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["SettingsViewModel registered as Transient in DI container","SettingsWindow.xaml has no DataContext instantiation in XAML","SettingsWindow constructor accepts SettingsViewModel parameter","SettingsWindow instantiation resolves SettingsViewModel from DI container","Application runs without runtime errors","Settings window opens and loads/saves configuration successfully"],"verification":["Verify services.AddTransient<SettingsViewModel>() in App.xaml.cs","Confirm Window.DataContext section removed from SettingsWindow.xaml","Verify SettingsWindow constructor signature: public SettingsWindow(SettingsViewModel viewModel)","Confirm DataContext = _viewModel; in SettingsWindow.xaml.cs constructor","Run application and open Settings window to verify functionality","Test Load and Save operations to confirm HttpClient works correctly"]},"commit":{"type":"refactor","scope":"desktop/di","message_template":"refactor(desktop/di): wire SettingsViewModel through DI container\n\nRegister SettingsViewModel as transient service and update SettingsWindow\nto resolve dependencies via constructor injection. Completes HttpClient\nlifecycle management refactoring.\n\nFixes: DSC-20260119-150946-011"},"depends_on":["T2"],"priority":3}],"is_bound":true,"bound_at":"2026-01-19T16:19:38.187Z"}
