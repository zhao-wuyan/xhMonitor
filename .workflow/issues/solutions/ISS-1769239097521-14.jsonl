{"id":"SOL-ISS-1769239097521-14-x7m2","description":"Extract DXGI and Performance Counter logic into separate provider classes","approach":"Create dedicated DxgiVramProvider and PerformanceCounterVramProvider classes that implement IMetricProvider interface. This separates low-level implementation details from SystemMetricProvider orchestration logic, improving maintainability and testability. The solution maintains backward compatibility by keeping the same fallback chain behavior.","analysis":{"risk":"low","impact":"medium","complexity":"medium"},"score":0.9,"tasks":[{"id":"T1","title":"Create DxgiVramProvider class","scope":"XhMonitor.Core/Providers","action":"Create","description":"Create new DxgiVramProvider class that encapsulates DXGI monitoring logic currently embedded in SystemMetricProvider","modification_points":["XhMonitor.Core/Providers/DxgiVramProvider.cs"],"implementation":["Create DxgiVramProvider.cs implementing IMetricProvider interface","Move DxgiGpuMonitor initialization logic from SystemMetricProvider constructor","Implement GetSystemTotalAsync() to return max VRAM from DXGI","Implement GetVramMetricsAsync() to return current VRAM usage via DXGI","Implement CollectAsync() for process-level VRAM (return 0 as DXGI doesn't support per-process)","Add proper disposal of DxgiGpuMonitor in Dispose()"],"test":{"unit":["Test DxgiVramProvider initialization success/failure","Test GetVramMetricsAsync returns valid metrics when DXGI available","Test GetVramMetricsAsync returns null when DXGI unavailable","Test Dispose properly cleans up DxgiGpuMonitor"],"commands":["dotnet test XhMonitor.Tests --filter DxgiVramProviderTests"]},"acceptance":{"criteria":["DxgiVramProvider implements IMetricProvider interface","GetVramMetricsAsync returns VramMetrics with Used/Total when DXGI available","GetVramMetricsAsync returns null when DXGI unavailable","Dispose properly releases DXGI resources","All unit tests pass"],"verification":["Verify class implements all IMetricProvider members","Run unit tests and confirm 100% pass rate","Check no memory leaks with repeated initialization/disposal"]},"commit":{"type":"feat","scope":"providers","message_template":"feat(providers): add DxgiVramProvider for DXGI monitoring\n\nExtract DXGI GPU monitoring logic into dedicated provider class.\nImplements IMetricProvider interface for consistent provider management."},"depends_on":[],"priority":1},{"id":"T2","title":"Create PerformanceCounterVramProvider class","scope":"XhMonitor.Core/Providers","action":"Create","description":"Create PerformanceCounterVramProvider class that encapsulates Performance Counter fallback logic","modification_points":["XhMonitor.Core/Providers/PerformanceCounterVramProvider.cs"],"implementation":["Create PerformanceCounterVramProvider.cs implementing IMetricProvider","Move Performance Counter logic from SystemMetricProvider.GetVramUsageAsync (lines 203-224)","Implement GetSystemTotalAsync() to iterate GPU Adapter Memory instances","Implement GetVramMetricsAsync() to return null (Performance Counters don't provide total capacity)","Implement CollectAsync() for process-level VRAM using GPU Process Memory counters","Add error handling for missing Performance Counter categories"],"test":{"unit":["Test PerformanceCounterVramProvider when GPU Adapter Memory category exists","Test graceful handling when Performance Counter category missing","Test GetSystemTotalAsync aggregates all GPU adapter instances","Test CollectAsync returns 0 when no matching process instances found"],"commands":["dotnet test XhMonitor.Tests --filter PerformanceCounterVramProviderTests"]},"acceptance":{"criteria":["PerformanceCounterVramProvider implements IMetricProvider interface","GetSystemTotalAsync aggregates all GPU Adapter Memory instances","GetVramMetricsAsync returns null (no total capacity available)","CollectAsync works for process-level VRAM monitoring","Graceful error handling when Performance Counters unavailable","All unit tests pass"],"verification":["Verify class implements all IMetricProvider members","Run unit tests and confirm 100% pass rate","Test on system without GPU Performance Counters"]},"commit":{"type":"feat","scope":"providers","message_template":"feat(providers): add PerformanceCounterVramProvider for fallback monitoring\n\nExtract Performance Counter VRAM logic into dedicated provider.\nProvides fallback when DXGI unavailable."},"depends_on":[],"priority":1},{"id":"T3","title":"Refactor SystemMetricProvider to use new providers","scope":"XhMonitor.Core/Providers","action":"Update","description":"Remove DXGI and Performance Counter logic from SystemMetricProvider, delegate to new provider classes","modification_points":["XhMonitor.Core/Providers/SystemMetricProvider.cs"],"implementation":["Remove _dxgiMonitor field and _dxgiAvailable flag (lines 23-24)","Remove DXGI initialization logic from constructor (lines 41-59)","Update GetVramUsageAsync() to only use _vramProvider.GetVramMetricsAsync()","Remove Performance Counter fallback logic (lines 183-231)","Remove DxgiGpuMonitor disposal from Dispose() method","Simplify constructor - remove initializeDxgi parameter","Keep existing provider orchestration logic unchanged"],"test":{"unit":["Test SystemMetricProvider with DxgiVramProvider","Test SystemMetricProvider with PerformanceCounterVramProvider","Test SystemMetricProvider with VramMetricProvider (LibreHardwareMonitor)","Test GetVramUsageAsync returns correct values from provider","Test GetMaxVramAsync returns correct values from provider"],"commands":["dotnet test XhMonitor.Tests --filter SystemMetricProviderTests"]},"acceptance":{"criteria":["No DXGI logic remains in SystemMetricProvider","No Performance Counter logic remains in SystemMetricProvider","GetVramUsageAsync delegates to _vramProvider only","Constructor simplified without initializeDxgi parameter","All existing tests pass","No behavioral changes to external API"],"verification":["Code review confirms no low-level implementation details","Run full test suite and confirm no regressions","Verify VRAM metrics still work in production"]},"commit":{"type":"refactor","scope":"providers","message_template":"refactor(providers): extract DXGI and Performance Counter logic from SystemMetricProvider\n\nDelegate VRAM monitoring to dedicated provider classes.\nSimplifies SystemMetricProvider to pure orchestration role."},"depends_on":["T1","T2"],"priority":2},{"id":"T4","title":"Update DI registration in Program.cs","scope":"XhMonitor.Service","action":"Update","description":"Update dependency injection to use new provider classes based on configuration","modification_points":["XhMonitor.Service/Program.cs"],"implementation":["Update SystemMetricProvider registration (lines 141-153)","Remove initializeDxgi parameter from SystemMetricProvider constructor call","Update MetricProviderRegistry to register DxgiVramProvider or PerformanceCounterVramProvider","Add logic: if LibreHardwareMonitor enabled, use existing VramMetricProvider","If LibreHardwareMonitor disabled, register DxgiVramProvider with PerformanceCounterVramProvider fallback","Ensure provider selection matches previous behavior"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Service","dotnet test XhMonitor.Tests --filter IntegrationTests"]},"acceptance":{"criteria":["SystemMetricProvider registration updated","Provider selection logic matches previous behavior","LibreHardwareMonitor path uses VramMetricProvider","Traditional path uses DxgiVramProvider â†’ PerformanceCounterVramProvider fallback","Application builds successfully","Integration tests pass"],"verification":["Build succeeds without errors","Run application and verify VRAM metrics work","Check logs confirm correct provider initialization"]},"commit":{"type":"refactor","scope":"di","message_template":"refactor(di): update DI registration for new VRAM providers\n\nRegister DxgiVramProvider and PerformanceCounterVramProvider based on configuration."},"depends_on":["T3"],"priority":3}],"is_bound":true,"bound_at":"2026-01-24T07:39:59.527Z"}
