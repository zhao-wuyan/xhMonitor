{"id":"SOL-ISS-1769239097521-5-k7m2","description":"Fix unsafe async cleanup in application shutdown by implementing proper async/await pattern","approach":"The current implementation uses fire-and-forget pattern (_ = asyncMethod()) in OnExit and OnSessionEnding, which creates race conditions where the application may terminate before cleanup completes. This can leave orphaned backend processes running. Solution: Convert ExitApplication to use proper async/await, implement synchronous cleanup in OnExit with timeout, and ensure OnSessionEnding waits for service shutdown.","analysis":{"risk":"low","impact":"medium","complexity":"low"},"score":0.9,"tasks":[{"id":"T1","title":"Implement synchronous cleanup in OnExit with timeout","scope":"XhMonitor.Desktop/App.xaml.cs","action":"Update","description":"Replace fire-and-forget async disposal with synchronous wait pattern using GetAwaiter().GetResult() with timeout to ensure cleanup completes before process termination","modification_points":["App.xaml.cs lines 61-80 (OnExit method)"],"implementation":["Remove fire-and-forget pattern: _ = _serviceProvider.DisposeAsync().AsTask()","Add synchronous service stop calls with timeout: _backendService?.StopAsync().GetAwaiter().GetResult() wrapped in try-catch","Add synchronous service provider disposal: _serviceProvider?.DisposeAsync().AsTask().Wait(TimeSpan.FromSeconds(3))","Ensure all cleanup completes before calling base.OnExit(e)"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["OnExit method completes all cleanup synchronously","No fire-and-forget async calls remain in OnExit","Cleanup has 3-second timeout to prevent hang","Application shutdown does not leave orphaned processes"],"verification":["Build succeeds without warnings","Manual test: Exit application and verify no XhMonitor.Service processes remain running","Code review: Confirm no _ = async pattern in OnExit"]},"commit":{"type":"fix","scope":"desktop","message_template":"fix(desktop): ensure synchronous cleanup in OnExit to prevent orphaned processes"},"depends_on":[],"priority":1},{"id":"T2","title":"Fix OnSessionEnding to wait for service shutdown","scope":"XhMonitor.Desktop/App.xaml.cs","action":"Update","description":"Replace fire-and-forget pattern in OnSessionEnding with synchronous wait to ensure services stop before system shutdown/logoff","modification_points":["App.xaml.cs lines 82-87 (OnSessionEnding method)"],"implementation":["Remove fire-and-forget calls: _ = _backendService?.StopAsync() and _ = _webService?.StopAsync()","Add synchronous wait with timeout: Task.WaitAll with 2-second timeout for both service stop tasks","Wrap in try-catch to handle timeout gracefully"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop/XhMonitor.Desktop.csproj"]},"acceptance":{"criteria":["OnSessionEnding waits for service shutdown synchronously","2-second timeout prevents blocking system shutdown","No fire-and-forget async calls in OnSessionEnding"],"verification":["Build succeeds without warnings","Code review: Confirm synchronous wait pattern used"]},"commit":{"type":"fix","scope":"desktop","message_template":"fix(desktop): wait for service shutdown in OnSessionEnding"},"depends_on":["T1"],"priority":2}],"is_bound":true,"bound_at":"2026-01-24T07:39:37.602Z"}
