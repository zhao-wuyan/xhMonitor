{"id":"SOL-DSC-20260119-150946-004-p9x4","description":"Add GetVramMetricsAsync to IMetricProvider interface to eliminate type checking and support Open/Closed Principle","approach":"Extend IMetricProvider interface with optional GetVramMetricsAsync method, update all providers to implement it (return null for non-VRAM providers), refactor SystemMetricProvider to use interface method instead of type checking","analysis":{"risk":"medium","impact":"medium","complexity":"medium"},"score":0.85,"tasks":[{"id":"T1","title":"Add GetVramMetricsAsync to IMetricProvider interface","scope":"XhMonitor.Core/Interfaces","action":"Update","description":"Extend IMetricProvider interface with optional GetVramMetricsAsync method for VRAM-specific metrics","modification_points":[{"file":"XhMonitor.Core/Interfaces/IMetricProvider.cs","target":"interface body after GetSystemTotalAsync method","change":"Add Task<VramMetrics?> GetVramMetricsAsync() method with default implementation returning null"}],"implementation":["Open XhMonitor.Core/Interfaces/IMetricProvider.cs","Add using statement: using XhMonitor.Core.Models;","Add new method to interface after GetSystemTotalAsync (around line 48):","  /// <summary>","  /// 获取完整的 VRAM 指标（仅 VRAM 提供者实现，其他返回 null）","  /// Get complete VRAM metrics (only implemented by VRAM providers, others return null)","  /// </summary>","  /// <returns>VRAM metrics or null if not applicable</returns>","  Task<VramMetrics?> GetVramMetricsAsync() => Task.FromResult<VramMetrics?>(null);","This uses C# 8.0+ default interface implementation to avoid breaking existing providers"],"test":{"unit":["Verify interface compiles successfully","Verify default implementation returns null","Verify existing providers still compile without changes"],"commands":["dotnet build XhMonitor.Core"]},"acceptance":{"criteria":["IMetricProvider interface includes GetVramMetricsAsync method","Method has default implementation returning Task.FromResult<VramMetrics?>(null)","Method signature is Task<VramMetrics?> GetVramMetricsAsync()","Interface compiles without errors"],"verification":["Check method exists in IMetricProvider.cs","Verify dotnet build succeeds","Verify existing providers compile without modification"]},"commit":{"type":"feat","scope":"core","message_template":"feat(core): add GetVramMetricsAsync to IMetricProvider for extensibility"},"depends_on":[],"priority":1},{"id":"T2","title":"Implement GetVramMetricsAsync in LibreHardwareMonitorVramProvider","scope":"XhMonitor.Core/Providers","action":"Update","description":"Override GetVramMetricsAsync in LibreHardwareMonitorVramProvider to return actual implementation","modification_points":[{"file":"XhMonitor.Core/Providers/LibreHardwareMonitorVramProvider.cs","target":"existing GetVramMetricsAsync method around line 42","change":"No change needed - method already exists and matches interface signature"}],"implementation":["Open XhMonitor.Core/Providers/LibreHardwareMonitorVramProvider.cs","Verify existing GetVramMetricsAsync method (line 42-172) matches new interface signature","Method already returns Task<VramMetrics> - change return type to Task<VramMetrics?> for consistency","Update method signature from 'public async Task<VramMetrics> GetVramMetricsAsync()' to 'public async Task<VramMetrics?> GetVramMetricsAsync()'","No logic changes needed - method already implements the required functionality","The method will now explicitly implement the interface method"],"test":{"unit":["Verify LibreHardwareMonitorVramProvider compiles successfully","Verify GetVramMetricsAsync returns VramMetrics when hardware available","Verify method can be called through IMetricProvider interface"],"commands":["dotnet build XhMonitor.Core"]},"acceptance":{"criteria":["GetVramMetricsAsync method signature matches interface (Task<VramMetrics?>)","Method implementation unchanged (still returns VramMetrics data)","Provider compiles without errors","Method accessible through IMetricProvider interface"],"verification":["Check method signature is Task<VramMetrics?> GetVramMetricsAsync()","Verify dotnet build succeeds","Verify method can be called via IMetricProvider reference"]},"commit":{"type":"refactor","scope":"core","message_template":"refactor(core): align LibreHardwareMonitorVramProvider with IMetricProvider interface"},"depends_on":["T1"],"priority":2},{"id":"T3","title":"Implement GetVramMetricsAsync in VramMetricProvider","scope":"XhMonitor.Core/Providers","action":"Update","description":"Add GetVramMetricsAsync implementation to VramMetricProvider for consistency","modification_points":[{"file":"XhMonitor.Core/Providers/VramMetricProvider.cs","target":"after GetSystemTotalAsync method around line 70","change":"Add GetVramMetricsAsync method that returns null (not applicable for PerformanceCounter-based provider)"}],"implementation":["Open XhMonitor.Core/Providers/VramMetricProvider.cs","Add new method after GetSystemTotalAsync (around line 70):","  /// <summary>","  /// 获取完整的 VRAM 指标（PerformanceCounter 提供者不支持，返回 null）","  /// </summary>","  public Task<VramMetrics?> GetVramMetricsAsync()","  {","      // PerformanceCounter-based provider doesn't support detailed VRAM metrics","      return Task.FromResult<VramMetrics?>(null);","  }","This explicitly implements the interface method with null return for non-LHM provider"],"test":{"unit":["Verify VramMetricProvider compiles successfully","Verify GetVramMetricsAsync returns null","Verify existing functionality unchanged"],"commands":["dotnet build XhMonitor.Core"]},"acceptance":{"criteria":["VramMetricProvider implements GetVramMetricsAsync","Method returns Task.FromResult<VramMetrics?>(null)","Provider compiles without errors","Existing GetSystemTotalAsync functionality unchanged"],"verification":["Check method exists in VramMetricProvider.cs","Verify method returns null","Verify dotnet build succeeds"]},"commit":{"type":"feat","scope":"core","message_template":"feat(core): implement GetVramMetricsAsync in VramMetricProvider"},"depends_on":["T1"],"priority":2},{"id":"T4","title":"Refactor SystemMetricProvider to use interface method","scope":"XhMonitor.Core/Providers","action":"Update","description":"Replace type checking with interface method calls in SystemMetricProvider","modification_points":[{"file":"XhMonitor.Core/Providers/SystemMetricProvider.cs","target":"GetMaxVramAsync method around line 102-123","change":"Replace type checking (is LibreHardwareMonitorVramProvider) with interface method call"},{"file":"XhMonitor.Core/Providers/SystemMetricProvider.cs","target":"GetVramUsageAsync method around line 171-185","change":"Replace type checking (is LibreHardwareMonitorVramProvider) with interface method call"}],"implementation":["Open XhMonitor.Core/Providers/SystemMetricProvider.cs","Refactor GetMaxVramAsync method (lines 102-123):","  Replace lines 109-114 with:","    // Try GetVramMetricsAsync first (works for any provider that implements it)","    var vramMetrics = await _vramProvider.GetVramMetricsAsync();","    if (vramMetrics != null && vramMetrics.IsValid)","    {","        return vramMetrics.Total;","    }","  Keep fallback to VramMetricProvider.GetSystemTotalAsync (lines 116-120)","Refactor GetVramUsageAsync method (lines 171-185):","  Replace lines 179-185 with:","    // Try GetVramMetricsAsync first (works for any provider that implements it)","    var vramMetrics = await _vramProvider.GetVramMetricsAsync();","    if (vramMetrics != null && vramMetrics.IsValid)","    {","        _logger?.LogInformation(\"[SystemMetricProvider] GetVramUsageAsync: Used={Used} MB, Total={Total} MB\",","            vramMetrics.Used, vramMetrics.Total);","        return vramMetrics.Used;","    }","  Keep existing DXGI/PerformanceCounter fallback logic (lines 188-220)","Remove all type checking: no more 'is LibreHardwareMonitorVramProvider' or 'is VramMetricProvider'"],"test":{"unit":["Verify SystemMetricProvider compiles successfully","Verify GetMaxVramAsync works with LibreHardwareMonitorVramProvider","Verify GetMaxVramAsync falls back correctly for VramMetricProvider","Verify GetVramUsageAsync works with both provider types","Verify no type checking remains in the code"],"commands":["dotnet build XhMonitor.Core","dotnet test XhMonitor.Tests"]},"acceptance":{"criteria":["No type checking (is LibreHardwareMonitorVramProvider) in SystemMetricProvider","GetMaxVramAsync uses _vramProvider.GetVramMetricsAsync() first","GetVramUsageAsync uses _vramProvider.GetVramMetricsAsync() first","Fallback logic preserved for providers returning null","SystemMetricProvider compiles without errors","All existing tests pass"],"verification":["Search code for 'is LibreHardwareMonitorVramProvider' - should find 0 results","Verify GetMaxVramAsync calls GetVramMetricsAsync","Verify GetVramUsageAsync calls GetVramMetricsAsync","Verify dotnet build succeeds","Run tests and verify no regression"]},"commit":{"type":"refactor","scope":"core","message_template":"refactor(core): eliminate type checking in SystemMetricProvider using interface method"},"depends_on":["T2","T3"],"priority":3},{"id":"T5","title":"Update other providers to implement GetVramMetricsAsync","scope":"XhMonitor.Core/Providers","action":"Update","description":"Ensure all IMetricProvider implementations explicitly implement GetVramMetricsAsync (even if using default)","modification_points":[{"file":"XhMonitor.Core/Providers/CpuMetricProvider.cs","target":"class body","change":"Add explicit GetVramMetricsAsync implementation returning null"},{"file":"XhMonitor.Core/Providers/MemoryMetricProvider.cs","target":"class body","change":"Add explicit GetVramMetricsAsync implementation returning null"},{"file":"XhMonitor.Core/Providers/GpuMetricProvider.cs","target":"class body","change":"Add explicit GetVramMetricsAsync implementation returning null"},{"file":"XhMonitor.Core/Providers/LibreHardwareMonitorCpuProvider.cs","target":"class body","change":"Add explicit GetVramMetricsAsync implementation returning null"},{"file":"XhMonitor.Core/Providers/LibreHardwareMonitorMemoryProvider.cs","target":"class body","change":"Add explicit GetVramMetricsAsync implementation returning null"},{"file":"XhMonitor.Core/Providers/LibreHardwareMonitorGpuProvider.cs","target":"class body","change":"Add explicit GetVramMetricsAsync implementation returning null"}],"implementation":["For each non-VRAM provider (CPU, Memory, GPU and their LHM variants):","  Open the provider file","  Add method after GetSystemTotalAsync:","    /// <summary>","    /// 获取完整的 VRAM 指标（不适用于此提供者）","    /// </summary>","    public Task<VramMetrics?> GetVramMetricsAsync()","    {","        return Task.FromResult<VramMetrics?>(null);","    }","This makes the interface implementation explicit and clear","Providers to update:","  - CpuMetricProvider.cs","  - MemoryMetricProvider.cs","  - GpuMetricProvider.cs","  - LibreHardwareMonitorCpuProvider.cs","  - LibreHardwareMonitorMemoryProvider.cs","  - LibreHardwareMonitorGpuProvider.cs"],"test":{"unit":["Verify all providers compile successfully","Verify all providers implement GetVramMetricsAsync","Verify non-VRAM providers return null","Verify existing functionality unchanged"],"commands":["dotnet build XhMonitor.Core","dotnet test XhMonitor.Tests"]},"acceptance":{"criteria":["All 6 non-VRAM providers implement GetVramMetricsAsync","All implementations return Task.FromResult<VramMetrics?>(null)","All providers compile without errors","No breaking changes to existing functionality","All tests pass"],"verification":["Check each provider file has GetVramMetricsAsync method","Verify all return null","Verify dotnet build succeeds","Run full test suite and verify no regression"]},"commit":{"type":"feat","scope":"core","message_template":"feat(core): implement GetVramMetricsAsync in all metric providers"},"depends_on":["T1"],"priority":2}],"is_bound":true,"bound_at":"2026-01-19T16:19:34.695Z"}
