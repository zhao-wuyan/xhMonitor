{"id":"SOL-ISS-20260127-006-r9n4","description":"将 StartupManager 和 AdminModeManager 重构为接口+实现模式，支持依赖注入和单元测试","approach":"当前 StartupManager 和 AdminModeManager 是静态类，直接操作注册表和进程，无法进行单元测试。解决方案是：1) 提取 IStartupManager 和 IAdminModeManager 接口；2) 将静态类改为实例类实现接口；3) 在 DI 容器中注册为单例；4) 更新调用方使用依赖注入。这样做的好处：可以在测试中 Mock 注册表和进程操作，提高代码可测试性。实现时保持向后兼容，现有功能不变。","tasks":[{"id":"T1","title":"创建 IStartupManager 接口","scope":"XhMonitor.Desktop/Services","action":"Create","description":"创建 IStartupManager 接口，定义开机自启动管理的契约","modification_points":[{"file":"XhMonitor.Desktop/Services/IStartupManager.cs","target":"新文件","change":"创建接口，包含 SetStartup 和 IsStartupEnabled 方法签名"}],"implementation":["在 XhMonitor.Desktop/Services 目录下创建 IStartupManager.cs","定义 public interface IStartupManager","添加 bool SetStartup(bool enable) 方法签名","添加 bool IsStartupEnabled() 方法签名","添加 XML 注释说明接口用途"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop"]},"acceptance":{"criteria":["IStartupManager.cs 文件创建成功","包含 SetStartup 和 IsStartupEnabled 两个方法签名","XML 注释完整"]},"commit":{"type":"refactor","scope":"Desktop","message_template":"refactor(Desktop): 创建 IStartupManager 接口"},"depends_on":[],"priority":1},{"id":"T2","title":"创建 IAdminModeManager 接口","scope":"XhMonitor.Desktop/Services","action":"Create","description":"创建 IAdminModeManager 接口，定义管理员模式管理的契约","modification_points":[{"file":"XhMonitor.Desktop/Services/IAdminModeManager.cs","target":"新文件","change":"创建接口，包含 IsRunningAsAdministrator 和 RestartAsAdministrator 方法签名"}],"implementation":["在 XhMonitor.Desktop/Services 目录下创建 IAdminModeManager.cs","定义 public interface IAdminModeManager","添加 bool IsRunningAsAdministrator() 方法签名","添加 bool RestartAsAdministrator() 方法签名","添加 XML 注释说明接口用途"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop"]},"acceptance":{"criteria":["IAdminModeManager.cs 文件创建成功","包含 IsRunningAsAdministrator 和 RestartAsAdministrator 两个方法签名","XML 注释完整"]},"commit":{"type":"refactor","scope":"Desktop","message_template":"refactor(Desktop): 创建 IAdminModeManager 接口"},"depends_on":[],"priority":1},{"id":"T3","title":"重构 StartupManager 为实例类","scope":"XhMonitor.Desktop/Services/StartupManager.cs","action":"Update","description":"将 StartupManager 从静态类改为实例类，实现 IStartupManager 接口","modification_points":[{"file":"XhMonitor.Desktop/Services/StartupManager.cs","target":"类声明 (line 10)","change":"将 public static class StartupManager 改为 public class StartupManager : IStartupManager"},{"file":"XhMonitor.Desktop/Services/StartupManager.cs","target":"方法签名 (line 20, 62)","change":"移除 static 关键字"}],"implementation":["将 public static class StartupManager 改为 public class StartupManager : IStartupManager","移除 SetStartup 方法的 static 关键字","移除 IsStartupEnabled 方法的 static 关键字","保持方法实现不变","添加无参构造函数（可选，用于 DI）"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop"]},"acceptance":{"criteria":["StartupManager 实现 IStartupManager 接口","SetStartup 和 IsStartupEnabled 不再是静态方法","代码编译通过"]},"commit":{"type":"refactor","scope":"Desktop","message_template":"refactor(Desktop): StartupManager 改为实例类实现 IStartupManager"},"depends_on":["T1"],"priority":2},{"id":"T4","title":"重构 AdminModeManager 为实例类","scope":"XhMonitor.Desktop/Services/AdminModeManager.cs","action":"Update","description":"将 AdminModeManager 从静态类改为实例类，实现 IAdminModeManager 接口","modification_points":[{"file":"XhMonitor.Desktop/Services/AdminModeManager.cs","target":"类声明 (line 9)","change":"将 public static class AdminModeManager 改为 public class AdminModeManager : IAdminModeManager"},{"file":"XhMonitor.Desktop/Services/AdminModeManager.cs","target":"方法签名 (line 15, 34)","change":"移除 static 关键字"}],"implementation":["将 public static class AdminModeManager 改为 public class AdminModeManager : IAdminModeManager","移除 IsRunningAsAdministrator 方法的 static 关键字","移除 RestartAsAdministrator 方法的 static 关键字","保持方法实现不变","添加无参构造函数（可选，用于 DI）"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop"]},"acceptance":{"criteria":["AdminModeManager 实现 IAdminModeManager 接口","IsRunningAsAdministrator 和 RestartAsAdministrator 不再是静态方法","代码编译通过"]},"commit":{"type":"refactor","scope":"Desktop","message_template":"refactor(Desktop): AdminModeManager 改为实例类实现 IAdminModeManager"},"depends_on":["T2"],"priority":2},{"id":"T5","title":"在 DI 容器中注册服务","scope":"XhMonitor.Desktop/App.xaml.cs","action":"Update","description":"在 App.xaml.cs 的 DI 容器中注册 IStartupManager 和 IAdminModeManager","modification_points":[{"file":"XhMonitor.Desktop/App.xaml.cs","target":"ConfigureServices 方法","change":"添加 services.AddSingleton<IStartupManager, StartupManager>() 和 services.AddSingleton<IAdminModeManager, AdminModeManager>()"}],"implementation":["在 App.xaml.cs 中找到 ConfigureServices 方法或服务注册区域","添加 services.AddSingleton<IStartupManager, StartupManager>();","添加 services.AddSingleton<IAdminModeManager, AdminModeManager>();","确保在 SettingsWindow 或其他依赖这些服务的组件之前注册"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop"]},"acceptance":{"criteria":["IStartupManager 和 IAdminModeManager 在 DI 容器中注册为单例","注册代码位置正确"]},"commit":{"type":"refactor","scope":"Desktop","message_template":"refactor(Desktop): 在 DI 容器中注册 IStartupManager 和 IAdminModeManager"},"depends_on":["T3","T4"],"priority":3},{"id":"T6","title":"更新 SettingsWindow 使用依赖注入","scope":"XhMonitor.Desktop/Windows/SettingsWindow.xaml.cs","action":"Update","description":"更新 SettingsWindow 通过构造函数注入 IStartupManager 和 IAdminModeManager","modification_points":[{"file":"XhMonitor.Desktop/Windows/SettingsWindow.xaml.cs","target":"构造函数和字段","change":"添加 IStartupManager 和 IAdminModeManager 字段，通过构造函数注入"},{"file":"XhMonitor.Desktop/Windows/SettingsWindow.xaml.cs","target":"Save_Click 方法 (line 34-109)","change":"将 StartupManager.IsStartupEnabled() 替换为 _startupManager.IsStartupEnabled()，将 AdminModeManager.IsRunningAsAdministrator() 替换为 _adminModeManager.IsRunningAsAdministrator()"}],"implementation":["在 SettingsWindow 类中添加私有字段 private readonly IStartupManager _startupManager; 和 private readonly IAdminModeManager _adminModeManager;","修改构造函数，添加 IStartupManager startupManager 和 IAdminModeManager adminModeManager 参数","在构造函数中赋值 _startupManager = startupManager; _adminModeManager = adminModeManager;","在 Save_Click 方法中，将 StartupManager.IsStartupEnabled() 替换为 _startupManager.IsStartupEnabled()","将 StartupManager.SetStartup() 替换为 _startupManager.SetStartup()","将 AdminModeManager.IsRunningAsAdministrator() 替换为 _adminModeManager.IsRunningAsAdministrator()","将 AdminModeManager.RestartAsAdministrator() 替换为 _adminModeManager.RestartAsAdministrator()"],"test":{"unit":[],"commands":["dotnet build XhMonitor.Desktop"]},"acceptance":{"criteria":["SettingsWindow 通过构造函数注入 IStartupManager 和 IAdminModeManager","Save_Click 方法使用注入的实例而非静态调用","代码编译通过","4 处静态调用全部替换为实例调用"]},"commit":{"type":"refactor","scope":"Desktop","message_template":"refactor(Desktop): SettingsWindow 使用依赖注入获取 Manager 服务\n\n- 通过构造函数注入 IStartupManager 和 IAdminModeManager\n- 替换 4 处静态方法调用为实例方法调用\n- 提高代码可测试性\n\nCloses ISS-20260127-006"},"depends_on":["T5"],"priority":4}],"analysis":{"risk":"medium","impact":"high","complexity":"medium"},"score":0.88,"is_bound":true,"bound_at":"2026-01-27T02:57:13.374Z"}
