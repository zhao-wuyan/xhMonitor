{"id":"SOL-ISS-1769239097521-21-c5m2","description":"Refactor MetricProviderRegistry to use factory pattern and DI for provider instantiation, eliminating direct 'new' operator usage","approach":"Introduce IMetricProviderFactory interface and concrete factory implementations to decouple provider instantiation from MetricProviderRegistry. This enables dependency injection for providers, improves testability, and allows runtime provider selection. The solution maintains backward compatibility with existing plugin loading while modernizing the built-in provider registration mechanism.","analysis":{"risk":"medium","impact":"medium","complexity":"medium"},"score":0.85,"tasks":[{"id":"T1","title":"Create IMetricProviderFactory interface","scope":"XhMonitor.Core/Interfaces","action":"Create","description":"Define factory interface for creating metric providers with dependency injection support","modification_points":["XhMonitor.Core/Interfaces/IMetricProviderFactory.cs (new file)"],"implementation":["Create new file XhMonitor.Core/Interfaces/IMetricProviderFactory.cs","Define public interface IMetricProviderFactory","Add method: IMetricProvider? CreateProvider(string metricId);","Add method: IEnumerable<string> GetSupportedMetricIds();","Add XML documentation explaining factory contract","Ensure namespace matches XhMonitor.Core.Interfaces"],"test":{"unit":["Verify interface can be implemented","Verify method signatures are correct","Create mock implementation for testing"],"commands":["dotnet build XhMonitor.Core"]},"acceptance":{"criteria":["IMetricProviderFactory interface created","Methods defined with correct signatures","XML documentation added","No compilation errors","Interface follows SOLID principles"],"verification":["Build XhMonitor.Core successfully","Interface can be implemented by concrete classes","Mock implementation compiles"]},"commit":{"type":"feat","scope":"core/interfaces","message_template":"feat(core/interfaces): add IMetricProviderFactory interface\n\nDefine factory interface for metric provider creation.\nEnables dependency injection and decouples instantiation\nfrom MetricProviderRegistry."},"depends_on":[],"priority":1},{"id":"T2","title":"Create BuiltInMetricProviderFactory implementation","scope":"XhMonitor.Service/Core","action":"Create","description":"Implement factory for creating built-in metric providers (CPU, Memory, GPU, VRAM) with DI support","modification_points":["XhMonitor.Service/Core/BuiltInMetricProviderFactory.cs (new file)"],"implementation":["Create new file XhMonitor.Service/Core/BuiltInMetricProviderFactory.cs","Implement IMetricProviderFactory interface","Inject ILoggerFactory and ILibreHardwareManager in constructor","Implement CreateProvider method with switch on metricId: cpu, memory, gpu, vram","For each case, instantiate appropriate provider (CpuMetricProvider, MemoryMetricProvider, etc.)","Pass required dependencies (ILogger, ILoggerFactory) from injected services","Implement GetSupportedMetricIds returning [\"cpu\", \"memory\", \"gpu\", \"vram\"]","Add null checks and validation for metricId parameter"],"test":{"unit":["Test CreateProvider for each supported metricId","Verify correct provider type is returned","Test with invalid metricId returns null","Verify dependencies are passed to providers","Test GetSupportedMetricIds returns correct list"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~BuiltInMetricProviderFactory"]},"acceptance":{"criteria":["BuiltInMetricProviderFactory implements IMetricProviderFactory","All 4 built-in providers supported","Dependencies injected via constructor","CreateProvider returns correct provider types","GetSupportedMetricIds returns complete list","Null checks and validation implemented"],"verification":["Build project successfully","All factory tests pass","Providers created with correct dependencies"]},"commit":{"type":"feat","scope":"service/core","message_template":"feat(service/core): add BuiltInMetricProviderFactory\n\nImplement factory for creating built-in metric providers.\nSupports CPU, Memory, GPU, VRAM with dependency injection."},"depends_on":["T1"],"priority":2},{"id":"T3","title":"Create LibreHardwareMonitorProviderFactory implementation","scope":"XhMonitor.Service/Core","action":"Create","description":"Implement factory for creating LibreHardwareMonitor hybrid providers with fallback support","modification_points":["XhMonitor.Service/Core/LibreHardwareMonitorProviderFactory.cs (new file)"],"implementation":["Create new file XhMonitor.Service/Core/LibreHardwareMonitorProviderFactory.cs","Implement IMetricProviderFactory interface","Inject ILoggerFactory, ILibreHardwareManager, and BuiltInMetricProviderFactory in constructor","Implement CreateProvider method creating hybrid providers (LibreHardwareMonitorCpuProvider, etc.)","For each hybrid provider, create fallback provider using BuiltInMetricProviderFactory","Pass ILibreHardwareManager and fallback provider to hybrid provider constructor","Implement GetSupportedMetricIds returning [\"cpu\", \"memory\", \"gpu\", \"vram\"]","Add initialization check for ILibreHardwareManager"],"test":{"unit":["Test CreateProvider for each hybrid provider","Verify fallback providers are created","Test with uninitialized LibreHardwareManager","Verify correct provider composition","Test GetSupportedMetricIds"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~LibreHardwareMonitorProviderFactory"]},"acceptance":{"criteria":["LibreHardwareMonitorProviderFactory implements IMetricProviderFactory","All 4 hybrid providers supported","Fallback providers created via BuiltInMetricProviderFactory","Dependencies injected correctly","Initialization check implemented","Tests pass"],"verification":["Build project successfully","Factory tests pass","Hybrid providers work with fallback"]},"commit":{"type":"feat","scope":"service/core","message_template":"feat(service/core): add LibreHardwareMonitorProviderFactory\n\nImplement factory for LibreHardwareMonitor hybrid providers.\nIncludes fallback to built-in providers via composition."},"depends_on":["T2"],"priority":2},{"id":"T4","title":"Refactor RegisterBuiltInProviders to use factories","scope":"XhMonitor.Service/Core","action":"Update","description":"Update MetricProviderRegistry.RegisterBuiltInProviders to use factory pattern instead of direct instantiation","modification_points":["XhMonitor.Service/Core/MetricProviderRegistry.cs:140-233"],"implementation":["Add IMetricProviderFactory _providerFactory field to MetricProviderRegistry","Update constructor to accept IMetricProviderFactory providerFactory parameter","Store factory in _providerFactory field","Refactor RegisterBuiltInProviders method to use factory","Replace direct 'new' calls with _providerFactory.CreateProvider(metricId)","Remove conditional logic for LibreHardwareMonitor (handled by factory selection)","Simplify method to iterate over _providerFactory.GetSupportedMetricIds()","For each metricId, call CreateProvider and RegisterProvider","Keep existing logging for registration success/failure"],"test":{"unit":["Test RegisterBuiltInProviders with BuiltInMetricProviderFactory","Test RegisterBuiltInProviders with LibreHardwareMonitorProviderFactory","Verify all providers are registered","Verify logging is correct","Test with factory returning null"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~MetricProviderRegistry"]},"acceptance":{"criteria":["IMetricProviderFactory field added","Constructor accepts factory parameter","RegisterBuiltInProviders uses factory.CreateProvider","Direct 'new' calls removed","Conditional LibreHardwareMonitor logic removed","Logging preserved","Tests pass"],"verification":["Build project successfully","All MetricProviderRegistry tests pass","Providers registered correctly via factory"]},"commit":{"type":"refactor","scope":"service/core","message_template":"refactor(service/core): use factory pattern in MetricProviderRegistry\n\nReplace direct provider instantiation with IMetricProviderFactory.\nSimplifies RegisterBuiltInProviders and enables DI for providers."},"depends_on":["T3"],"priority":3},{"id":"T5","title":"Register factories in Program.cs DI container","scope":"XhMonitor.Service","action":"Update","description":"Register IMetricProviderFactory implementations in DI container with conditional selection","modification_points":["XhMonitor.Service/Program.cs:121-139"],"implementation":["Before MetricProviderRegistry registration (line 121), add factory registration","Add: builder.Services.AddSingleton<BuiltInMetricProviderFactory>();","Add conditional factory registration based on PreferLibreHardwareMonitor config","Add: var preferLHM = builder.Configuration.GetValue<bool>(\"MetricProviders:PreferLibreHardwareMonitor\", true);","Add: if (preferLHM) { builder.Services.AddSingleton<IMetricProviderFactory, LibreHardwareMonitorProviderFactory>(); }","Add: else { builder.Services.AddSingleton<IMetricProviderFactory, BuiltInMetricProviderFactory>(); }","Update MetricProviderRegistry registration to inject IMetricProviderFactory","Remove hardwareManager and preferLibreHardwareMonitor parameters from MetricProviderRegistry constructor call"],"test":{"unit":["Test DI container resolves correct factory based on configuration","Test MetricProviderRegistry resolves with factory","Verify providers are created via factory","Test with PreferLibreHardwareMonitor = true","Test with PreferLibreHardwareMonitor = false"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~DependencyInjection"]},"acceptance":{"criteria":["BuiltInMetricProviderFactory registered as singleton","IMetricProviderFactory registered conditionally","MetricProviderRegistry updated to use factory","Configuration-based factory selection works","No compilation errors","Tests pass"],"verification":["Build project successfully","Application starts with both configurations","Correct factory is resolved based on config","Providers work correctly"]},"commit":{"type":"feat","scope":"service/di","message_template":"feat(service/di): register metric provider factories\n\nRegister IMetricProviderFactory implementations in DI container.\nConditional selection based on PreferLibreHardwareMonitor config.\nUpdates MetricProviderRegistry to use injected factory."},"depends_on":["T4"],"priority":4},{"id":"T6","title":"Update MetricProviderRegistry constructor signature","scope":"XhMonitor.Service/Core","action":"Update","description":"Update MetricProviderRegistry constructor to remove hardwareManager and preferLibreHardwareMonitor parameters","modification_points":["XhMonitor.Service/Core/MetricProviderRegistry.cs:19-39"],"implementation":["Remove ILibreHardwareManager? hardwareManager parameter from constructor (line 23)","Remove bool preferLibreHardwareMonitor parameter from constructor (line 24)","Remove _hardwareManager field (line 13)","Remove _preferLibreHardwareMonitor field (line 14)","Remove IsLibreHardwareMonitorEnabled property (line 17)","Update constructor to only accept: ILogger, ILoggerFactory, string pluginDirectory, IMetricProviderFactory","Update secondary constructor (lines 36-39) to pass factory parameter","Remove all references to _hardwareManager and _preferLibreHardwareMonitor in RegisterBuiltInProviders"],"test":{"unit":["Test MetricProviderRegistry with new constructor signature","Verify factory is used for provider creation","Test with both factory implementations","Verify plugin loading still works"],"commands":["dotnet test XhMonitor.Tests --filter FullyQualifiedName~MetricProviderRegistry"]},"acceptance":{"criteria":["hardwareManager parameter removed","preferLibreHardwareMonitor parameter removed","Related fields removed","IsLibreHardwareMonitorEnabled property removed","Constructor accepts IMetricProviderFactory","All tests updated and passing"],"verification":["Build project successfully","All MetricProviderRegistry tests pass","No references to removed parameters"]},"commit":{"type":"refactor","scope":"service/core","message_template":"refactor(service/core): simplify MetricProviderRegistry constructor\n\nRemove hardwareManager and preferLibreHardwareMonitor parameters.\nFactory pattern now handles provider selection and instantiation."},"depends_on":["T5"],"priority":5}],"is_bound":true,"bound_at":"2026-01-24T07:42:35.116Z"}
