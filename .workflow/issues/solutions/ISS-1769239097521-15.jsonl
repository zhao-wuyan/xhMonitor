{"id":"SOL-ISS-1769239097521-15-a7x9","description":"Centralize port configuration using existing ServiceDiscovery pattern with dynamic fallback","approach":"Leverage the existing ServiceDiscovery infrastructure that already handles dynamic endpoint configuration via service-endpoints.json. Extend it to support port fallback when ports are in use, and update all hardcoded port references to use ServiceDiscovery. This approach maintains backward compatibility while enabling runtime port conflict resolution.","analysis":{"risk":"low","impact":"medium","complexity":"low"},"score":0.9,"tasks":[{"id":"T1","title":"Extend ServiceDiscovery to support port fallback","scope":"XhMonitor.Desktop/Services","action":"Update","description":"Add port availability checking and fallback logic to ServiceDiscovery to automatically find available ports when defaults are in use","modification_points":["XhMonitor.Desktop/Services/ServiceDiscovery.cs","XhMonitor.Desktop/Services/IServiceDiscovery.cs"],"implementation":["Add GetAvailablePort(int preferredPort) method to check port availability using TcpListener","Add ApiPort and SignalRPort properties to IServiceDiscovery interface","Parse ports from service-endpoints.json URLs in ServiceDiscovery constructor","Implement fallback: try preferred port, if in use try ports +1 to +10","Update ApiBaseUrl and SignalRUrl to use discovered ports"],"test":{"unit":["Test GetAvailablePort returns preferred port when available","Test GetAvailablePort returns fallback port when preferred is in use","Test ServiceDiscovery parses ports from URLs correctly","Test ServiceDiscovery uses default ports when config missing"],"commands":["dotnet test XhMonitor.Desktop.Tests --filter ServiceDiscoveryTests"]},"acceptance":{"criteria":["ServiceDiscovery exposes ApiPort and SignalRPort properties","Port fallback logic tries up to 10 alternative ports","All unit tests pass with 100% coverage for new methods","Backward compatible with existing service-endpoints.json format"],"verification":["Run unit tests and verify all pass","Start two instances simultaneously and verify second uses fallback ports","Check Debug output shows port discovery messages"]},"commit":{"type":"feat","scope":"desktop/services","message_template":"feat(desktop/services): add dynamic port fallback to ServiceDiscovery\n\nExtend ServiceDiscovery to automatically find available ports when defaults are in use. Adds port availability checking and fallback logic (tries +1 to +10 range)."},"depends_on":[],"priority":1},{"id":"T2","title":"Remove hardcoded ports from BackendServerService","scope":"XhMonitor.Desktop/Services","action":"Update","description":"Replace hardcoded port 35179 with ServiceDiscovery.ApiPort in BackendServerService","modification_points":["XhMonitor.Desktop/Services/BackendServerService.cs"],"implementation":["Remove GetBackendPort method that parses port from URL","Use serviceDiscovery.ApiPort directly instead of parsing","Update IsPortInUse and WaitForServerReadyAsync to use serviceDiscovery.ApiPort","Update all Debug.WriteLine statements to use serviceDiscovery.ApiPort"],"test":{"unit":["Test BackendServerService uses port from ServiceDiscovery","Test BackendServerService handles port changes correctly"],"commands":["dotnet test XhMonitor.Desktop.Tests --filter BackendServerServiceTests"]},"acceptance":{"criteria":["No hardcoded port 35179 in BackendServerService.cs","All port references use serviceDiscovery.ApiPort","Service starts successfully with dynamic port","All existing tests pass"],"verification":["Search codebase for '35179' in BackendServerService.cs (should find 0)","Run service and verify it uses port from ServiceDiscovery","Check Debug output shows correct port in log messages"]},"commit":{"type":"refactor","scope":"desktop/services","message_template":"refactor(desktop/services): use ServiceDiscovery port in BackendServerService\n\nReplace hardcoded port 35179 with dynamic port from ServiceDiscovery."},"depends_on":["T1"],"priority":2},{"id":"T3","title":"Remove hardcoded ports from WebServerService","scope":"XhMonitor.Desktop/Services","action":"Update","description":"Replace hardcoded port 35180 with ServiceDiscovery port in WebServerService","modification_points":["XhMonitor.Desktop/Services/WebServerService.cs"],"implementation":["Add webPort field initialized from serviceDiscovery (parse from SignalRUrl or use separate WebPort property)","Replace ConfigurationDefaults.System.WebPort with serviceDiscovery web port","Update all Debug.WriteLine statements to use dynamic port","Update WebApplication.CreateBuilder to use dynamic port"],"test":{"unit":["Test WebServerService uses port from ServiceDiscovery","Test WebServerService handles port changes correctly"],"commands":["dotnet test XhMonitor.Desktop.Tests --filter WebServerServiceTests"]},"acceptance":{"criteria":["No hardcoded port 35180 in WebServerService.cs","All port references use ServiceDiscovery","Web server starts successfully with dynamic port","All existing tests pass"],"verification":["Search codebase for '35180' in WebServerService.cs (should find 0)","Run web server and verify it uses port from ServiceDiscovery","Access web interface at dynamic port"]},"commit":{"type":"refactor","scope":"desktop/services","message_template":"refactor(desktop/services): use ServiceDiscovery port in WebServerService\n\nReplace hardcoded port 35180 with dynamic port from ServiceDiscovery."},"depends_on":["T1"],"priority":2},{"id":"T4","title":"Remove hardcoded ports from App.xaml.cs","scope":"XhMonitor.Desktop","action":"Update","description":"Replace hardcoded port 35180 in OpenWebInterface with ServiceDiscovery port","modification_points":["XhMonitor.Desktop/App.xaml.cs"],"implementation":["Inject IServiceDiscovery into App class via field","Parse web port from serviceDiscovery.SignalRUrl or add WebPort property","Update OpenWebInterface to use dynamic port in URL","Update error message to show dynamic port"],"test":{"unit":[],"commands":[]},"acceptance":{"criteria":["No hardcoded port 35180 in App.xaml.cs OpenWebInterface method","Web interface opens at correct dynamic port","Error message shows correct dynamic port"],"verification":["Search codebase for '35180' in App.xaml.cs (should find 0)","Click 'Open Web Interface' and verify correct URL opens","Trigger error and verify message shows correct port"]},"commit":{"type":"refactor","scope":"desktop","message_template":"refactor(desktop): use ServiceDiscovery port in App.xaml.cs\n\nReplace hardcoded port 35180 with dynamic port from ServiceDiscovery in OpenWebInterface."},"depends_on":["T1"],"priority":3},{"id":"T5","title":"Update documentation and scripts","scope":"Documentation","action":"Update","description":"Update all documentation and scripts to reference dynamic port configuration","modification_points":["README.md","scripts/启动服务.bat",".claude/plan/设置菜单功能.md"],"implementation":["Update README.md to explain service-endpoints.json and port fallback","Update 启动服务.bat to note ports may vary if defaults in use","Update 设置菜单功能.md to remove port configuration from settings UI","Add note that ports are infrastructure config, not user settings"],"test":{"unit":[],"commands":[]},"acceptance":{"criteria":["README.md documents service-endpoints.json format","README.md explains port fallback behavior","Scripts note dynamic port behavior","All documentation consistent with implementation"],"verification":["Review README.md for accuracy","Review scripts for correct messaging","Verify no documentation suggests ports are user-configurable"]},"commit":{"type":"docs","scope":"project","message_template":"docs: update documentation for dynamic port configuration\n\nDocument service-endpoints.json format and port fallback behavior. Update scripts to reflect dynamic ports."},"depends_on":["T2","T3","T4"],"priority":4}],"is_bound":true,"bound_at":"2026-01-24T07:40:09.601Z"}
