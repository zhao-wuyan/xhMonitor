{"id":"SOL-ISS-20260125-001-y6d1","description":"修复进程详情卡片（DetailsPopup）在主悬浮窗拖动时未跟随移动的问题，通过监听窗口 LocationChanged 事件强制更新 Popup 位置","approach":"WPF Popup 控件默认不会随父窗口拖动自动更新位置。解决方案是在 FloatingWindow 构造函数中订阅 LocationChanged 事件，当窗口位置变化时，通过修改 Popup.HorizontalOffset 或 VerticalOffset 属性（设置为 0 后立即恢复）强制触发 CustomPopupPlacementCallback 重新计算位置。这种方法利用了 WPF Popup 的内部机制：当 Offset 属性变化时，Popup 会重新调用 CustomPopupPlacementCallback 获取新位置。实现时需要注意：1) 仅在 Popup.IsOpen=true 时更新位置，避免不必要的计算；2) 使用 Dispatcher.BeginInvoke 延迟执行，确保窗口位置已完全更新；3) 遵循现有代码风格，与 SizeChanged 事件处理保持一致。","tasks":[{"id":"T1","title":"添加 LocationChanged 事件处理器","scope":"XhMonitor.Desktop/FloatingWindow.xaml.cs","action":"Update","description":"在 FloatingWindow 构造函数中订阅 LocationChanged 事件，实现窗口位置变化时强制更新 Popup 位置的逻辑","modification_points":[{"file":"XhMonitor.Desktop/FloatingWindow.xaml.cs","target":"FloatingWindow 构造函数 (line 63-83)","change":"在 line 82 (SizeChanged += OnWindowSizeChanged;) 后添加 LocationChanged 事件订阅"},{"file":"XhMonitor.Desktop/FloatingWindow.xaml.cs","target":"新增 OnLocationChanged 方法","change":"在 OnWindowSizeChanged 方法 (line 174-177) 后添加新的事件处理方法"}],"implementation":["在 FloatingWindow 构造函数中，找到 `SizeChanged += OnWindowSizeChanged;` (line 82)","在该行后添加新的事件订阅：`LocationChanged += OnLocationChanged;`","在 OnWindowSizeChanged 方法后（约 line 177 后）添加新方法 OnLocationChanged","方法实现逻辑：检查 DetailsPopup.IsOpen 是否为 true，如果是则通过 Dispatcher.BeginInvoke 延迟执行位置更新","位置更新方式：临时修改 HorizontalOffset（+= 0.01 后立即 -= 0.01），触发 CustomPopupPlacementCallback 重新计算","添加 Debug 输出，格式与现有代码保持一致：`System.Diagnostics.Debug.WriteLine($\"[Popup] Location Changed - Updating popup position\");`"],"test":{"unit":[],"commands":[],"manual_checks":["启动 XhMonitor.Desktop 应用","鼠标悬停在监控悬浮窗上，触发 DetailsPopup 弹出","拖动悬浮窗到屏幕不同位置（上方、下方、左侧、右侧）","验证 DetailsPopup 是否跟随悬浮窗移动，保持相对位置不变","检查 Debug 输出中是否有 [Popup] Location Changed 日志","验证 Popup 弹出方向（向上/向下）是否根据屏幕空间正确调整"]},"acceptance":{"criteria":["LocationChanged 事件成功订阅到 FloatingWindow 构造函数","OnLocationChanged 方法正确实现，仅在 Popup.IsOpen=true 时执行更新","使用 Dispatcher.BeginInvoke 延迟执行，确保窗口位置已更新","通过修改 HorizontalOffset 触发 CustomPopupPlacementCallback 重新计算","添加 Debug 日志输出，格式与现有代码一致"],"verification":["代码编译通过，无语法错误","手动测试：拖动悬浮窗时 DetailsPopup 跟随移动","手动测试：Popup 不会遮挡悬浮窗","手动测试：Popup 弹出方向根据屏幕空间自适应","Debug 输出中可见 [Popup] Location Changed 日志"],"manual_checks":["在不同屏幕位置（顶部、底部、左侧、右侧）测试拖动行为","验证 Popup 向上/向下弹出的自适应逻辑仍然正常工作","验证 PinnedStack 位置随 Popup 方向调整的逻辑不受影响","测试快速拖动窗口时 Popup 是否能及时跟随"]},"commit":{"type":"fix","scope":"Desktop","message_template":"fix(Desktop): 修复进程详情卡片未随悬浮窗拖动而移动\n\n- 添加 LocationChanged 事件处理器\n- 通过修改 HorizontalOffset 强制触发 Popup 位置重新计算\n- 使用 Dispatcher.BeginInvoke 确保窗口位置更新完成\n- 添加 Debug 日志输出\n\nCloses ISS-20260125-001"},"depends_on":[],"priority":1}],"analysis":{"risk":"low","impact":"low","complexity":"low"},"score":0.95,"is_bound":true,"created_at":"2026-01-25T00:00:00.000Z","bound_at":"2026-01-25T11:21:38.886Z"}
