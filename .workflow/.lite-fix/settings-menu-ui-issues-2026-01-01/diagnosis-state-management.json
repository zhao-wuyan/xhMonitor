{
  "symptom": {
    "description": "Settings menu has two primary state-management issues: (1) Unable to add process monitoring keywords through the UI - AddKeyword button appears non-functional; (2) Various style inconsistencies including incorrect spacing, alignment, and visual hierarchy across different sections",
    "error_message": null,
    "stack_trace": null,
    "frequency": "always",
    "user_impact": "Users cannot configure process monitoring keywords, limiting core monitoring functionality. Style inconsistencies create poor user experience and reduced usability"
  },
  "root_cause": {
    "file": "XhMonitor.Desktop/Windows/SettingsWindow.xaml.cs",
    "line_range": "65-72",
    "function": "AddKeyword_Click",
    "issue": "Missing Microsoft.VisualBasic assembly reference required for InputBox functionality. The csproj file (line 1-19) does not include Microsoft.VisualBasic.Core package reference, causing InputBox call at line 67 to fail silently at runtime. Additionally, ProcessKeywords ObservableCollection lacks explicit change notifications when items are added/removed via collection methods.",
    "confidence": 0.85,
    "introduced_by": "559d0b0 (feat: 添加应用配置管理功能并完善设置界面)",
    "category": "integration"
  },
  "affected_files": [
    {
      "path": "XhMonitor.Desktop/Windows/SettingsWindow.xaml.cs",
      "relevance": 0.95,
      "rationale": "Contains AddKeyword_Click handler using Microsoft.VisualBasic.Interaction.InputBox without proper package reference",
      "change_type": "fix_target"
    },
    {
      "path": "XhMonitor.Desktop/XhMonitor.Desktop.csproj",
      "relevance": 0.90,
      "rationale": "Missing Microsoft.VisualBasic.Core package reference needed for InputBox functionality",
      "change_type": "needs_update"
    },
    {
      "path": "XhMonitor.Desktop/ViewModels/SettingsViewModel.cs",
      "relevance": 0.75,
      "rationale": "ProcessKeywords property (line 50-54) uses ObservableCollection but lacks explicit CollectionChanged event handling for UI synchronization",
      "change_type": "needs_update"
    },
    {
      "path": "XhMonitor.Desktop/Windows/SettingsWindow.xaml",
      "relevance": 0.80,
      "rationale": "ListBox binding at line 132-137 is correct but may need SelectionMode and ContextMenu for keyword deletion. Style resources need review for consistency",
      "change_type": "needs_update"
    },
    {
      "path": "XhMonitor.Desktop/Extensions/ObservableCollectionExtensions.cs",
      "relevance": 0.60,
      "rationale": "Extension methods work correctly but AddRange (line 9-22) triggers individual Add events, may cause performance issues with large collections",
      "change_type": "reference_only"
    }
  ],
  "reproduction_steps": [
    "Launch XhMonitor Desktop application",
    "Open Settings menu via system tray or menu option",
    "Navigate to '数据采集' (Data Collection) section",
    "Click '+ 添加关键词' (Add Keyword) button",
    "Observe that no InputBox dialog appears or application throws runtime exception",
    "Observe style inconsistencies in spacing, font sizes, and control alignment across different sections"
  ],
  "fix_hints": [
    {
      "description": "Add Microsoft.VisualBasic.Core package reference to enable InputBox functionality",
      "approach": "Add PackageReference to XhMonitor.Desktop.csproj after line 16: <PackageReference Include=\"Microsoft.VisualBasic.Core\" Version=\"8.*\" />. This provides the required assembly for Microsoft.VisualBasic.Interaction.InputBox call at SettingsWindow.xaml.cs line 67",
      "code_example": "<ItemGroup>\n  <FrameworkReference Include=\"Microsoft.AspNetCore.App\" />\n  <PackageReference Include=\"Microsoft.AspNetCore.SignalR.Client\" Version=\"8.*\" />\n  <PackageReference Include=\"Microsoft.VisualBasic.Core\" Version=\"8.*\" />\n  <PackageReference Include=\"System.Text.Json\" Version=\"8.*\" />\n</ItemGroup>",
      "risk": "low"
    },
    {
      "description": "Replace Microsoft.VisualBasic.Interaction.InputBox with native WPF dialog for better UX and consistency",
      "approach": "Create a custom WPF InputDialog window or use MaterialDesignThemes TextFieldDialog for modern, consistent UI. This eliminates external dependency and provides better styling control. Update AddKeyword_Click handler (line 65-72) to use custom dialog",
      "code_example": "// Create InputDialog.xaml with TextBox and OK/Cancel buttons\nprivate async void AddKeyword_Click(object sender, RoutedEventArgs e)\n{\n    var dialog = new InputDialog { Owner = this, Title = \"添加关键词\" };\n    if (dialog.ShowDialog() == true && !string.IsNullOrWhiteSpace(dialog.InputText))\n    {\n        _viewModel.ProcessKeywords.Add(dialog.InputText);\n    }\n}",
      "risk": "low"
    },
    {
      "description": "Add delete keyword functionality with context menu or delete button",
      "approach": "Enable SelectionMode on ListBox (line 132) and add ContextMenu with Delete option. Wire to RemoveKeyword handler that removes selected item from ProcessKeywords ObservableCollection",
      "code_example": "<ListBox ItemsSource=\"{Binding ProcessKeywords}\" SelectionMode=\"Single\">\n    <ListBox.ContextMenu>\n        <ContextMenu>\n            <MenuItem Header=\"删除\" Click=\"RemoveKeyword_Click\"/>\n        </ContextMenu>\n    </ListBox.ContextMenu>\n</ListBox>\n\n// Code-behind:\nprivate void RemoveKeyword_Click(object sender, RoutedEventArgs e)\n{\n    if (KeywordsListBox.SelectedItem is string keyword)\n        _viewModel.ProcessKeywords.Remove(keyword);\n}",
      "risk": "low"
    },
    {
      "description": "Standardize style resources for consistent spacing, fonts, and colors across all sections",
      "approach": "Review XAML resources (line 16-64) and create unified margin/padding constants. Ensure all TextBlocks use consistent FontSize (currently mixed 14/16/20/24), standardize control heights (currently 35px for inputs), and use theme-based color references instead of hardcoded hex values",
      "code_example": "<!-- Add to Window.Resources -->\n<System:Double x:Key=\"LabelFontSize\">14</System:Double>\n<System:Double x:Key=\"HeaderFontSize\">20</System:Double>\n<System:Double x:Key=\"InputHeight\">35</System:Double>\n<Thickness x:Key=\"ControlMargin\">0,0,0,20</Thickness>\n\n<!-- Usage -->\n<TextBlock Text=\"系统指标采集间隔\" FontSize=\"{StaticResource LabelFontSize}\" Margin=\"0,0,0,5\"/>\n<TextBox Height=\"{StaticResource InputHeight}\" Margin=\"{StaticResource ControlMargin}\"/>",
      "risk": "low"
    },
    {
      "description": "Ensure ObservableCollection change notifications propagate correctly to UI binding",
      "approach": "ProcessKeywords property already uses SetProperty which triggers PropertyChanged. Verify LoadSettingsAsync (line 125) creates new ObservableCollection instance (correct) rather than modifying existing one. Consider subscribing to ProcessKeywords.CollectionChanged event if nested tracking is needed",
      "code_example": "// In SettingsViewModel constructor or property setter:\nprivate ObservableCollection<string> _processKeywords = new();\npublic ObservableCollection<string> ProcessKeywords\n{\n    get => _processKeywords;\n    set\n    {\n        if (_processKeywords != null)\n            _processKeywords.CollectionChanged -= OnKeywordsChanged;\n        SetProperty(ref _processKeywords, value);\n        if (_processKeywords != null)\n            _processKeywords.CollectionChanged += OnKeywordsChanged;\n    }\n}\n\nprivate void OnKeywordsChanged(object? sender, NotifyCollectionChangedEventArgs e)\n{\n    // Optional: Additional UI sync logic if needed\n}",
      "risk": "medium"
    }
  ],
  "dependencies": "Microsoft.VisualBasic.Core package (missing - required for InputBox), WPF data binding system (ObservableCollection, INotifyPropertyChanged), System.Text.Json for settings serialization",
  "constraints": "Must maintain MVVM pattern with ViewModel as single source of truth. Cannot modify ObservableCollection from non-UI thread without Dispatcher. Style changes must preserve dark theme consistency. Fix must not break existing data persistence to backend API",
  "related_issues": [
    {
      "type": "tech_debt",
      "reference": "ObservableCollectionExtensions.cs line 9-22",
      "description": "AddRange triggers individual PropertyChanged events rather than batched notification, may cause UI performance issues with large keyword lists"
    },
    {
      "type": "related_feature",
      "reference": "SettingsWindow.xaml line 132-137",
      "description": "No delete/edit functionality for keywords - users can only add, cannot remove or modify existing keywords"
    }
  ],
  "clarification_needs": [
    {
      "question": "Should keyword input use native WPF dialog or keep Microsoft.VisualBasic.Interaction.InputBox with package reference?",
      "context": "Current implementation uses VB InputBox (legacy WinForms style) which requires additional package. Native WPF dialog would provide better styling consistency with dark theme and modern UI patterns, but requires creating custom dialog window",
      "options": [
        "Add Microsoft.VisualBasic.Core package reference (quick fix, maintains current UI)",
        "Create custom WPF InputDialog window (better UX, consistent styling, more code)",
        "Use third-party dialog library like MaterialDesignThemes (modern UI, external dependency)"
      ]
    },
    {
      "question": "Should keyword management include delete/edit functionality in this fix?",
      "context": "Current implementation only supports adding keywords. Users have no way to remove incorrect or unwanted keywords except by restoring defaults (loses all keywords). ListBox binding is correct but lacks selection/context menu for deletion",
      "options": [
        "Add delete functionality with context menu (recommended - completes keyword management)",
        "Add both delete and edit functionality (full CRUD operations)",
        "Fix only add functionality, defer delete/edit to future iteration"
      ]
    }
  ],
  "_metadata": {
    "timestamp": "2026-01-01T12:36:42.000Z",
    "bug_description": "使用gemini审查设置菜单的UI问题,有无法添加进程监控关键词,还有各种样式问题",
    "source": "cli-explore-agent",
    "diagnosis_angle": "state-management",
    "diagnosis_index": 2,
    "total_diagnoses": 2,
    "duration_seconds": 85
  }
}
