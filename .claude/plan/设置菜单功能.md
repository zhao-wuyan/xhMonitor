## 📌 计划更新说明 (融合新 UI 设计)

**更新日期**: 2025-12-29
**更新原因**: 融合用户提供的新 UI 参考设计

**主要变更**:
1. ✅ **简化设置项** - 移除字体大小、CPU/GPU 阈值等高级配置
2. ✅ **现代化 UI** - 采用新的配色方案和样式系统
3. ✅ **新增"关于"页** - 展示应用信息和技术栈
4. ✅ **优化布局** - 窗口尺寸调整为 800x600，更宽敞的间距
5. ⚠️ **后端兼容** - 数据层保持完整,UI 层仅展示部分配置

**补充更新（2026-01-24）**：
- SignalR/Web 端口属于基础设施配置，不再作为设置项展示。
- Desktop 端改由 `service-endpoints.json` + `ServiceDiscovery` 管理端口，并支持自动回退。

---

## 📊 项目结构预览 (精简版)

```
XhMonitor/
├── XhMonitor.Core/
│   └── Entities/
│       └── ApplicationSettings.cs          # 新建 ⭐
├── XhMonitor.Service/
│   ├── Data/
│   │   └── MonitorDbContext.cs             # 修改 (简化种子数据)
│   ├── Migrations/
│   │   └── 20251229_AddApplicationSettings.cs  # 自动生成 ⭐
│   ├── Controllers/
│   │   └── ConfigController.cs             # 修改 (扩展 API)
│   └── Models/
│       └── SettingsDto.cs                  # 新建 ⭐
└── XhMonitor.Desktop/
    ├── Windows/
    │   ├── SettingsWindow.xaml             # 新建 ⭐ (现代化设计)
    │   └── SettingsWindow.xaml.cs          # 新建 ⭐
    ├── ViewModels/
    │   └── SettingsViewModel.cs            # 新建 ⭐ (精简版)
    └── App.xaml.cs                         # 修改 (添加菜单项)
```

---

## 🎯 Phase 1: 后端数据层开发

### 1.1 创建实体类 `ApplicationSettings`

**文件**: `XhMonitor.Core/Entities/ApplicationSettings.cs`

**原子操作**:
```csharp
using System.ComponentModel.DataAnnotations;

namespace XhMonitor.Core.Entities;

/// <summary>
/// 应用配置实体
/// </summary>
public class ApplicationSettings
{
    /// <summary>主键</summary>
    public int Id { get; set; }
    
    /// <summary>配置分类 (Appearance/DataCollection/System)</summary>
    [Required]
    [MaxLength(50)]
    public string Category { get; set; } = string.Empty;
    
    /// <summary>配置键</summary>
    [Required]
    [MaxLength(100)]
    public string Key { get; set; } = string.Empty;
    
    /// <summary>配置值 (JSON 格式)</summary>
    [Required]
    public string Value { get; set; } = string.Empty;
    
    /// <summary>创建时间</summary>
    public DateTime CreatedAt { get; set; }
    
    /// <summary>更新时间</summary>
    public DateTime UpdatedAt { get; set; }
}
```

**预期结果**: 实体类可被 EF Core 识别

---

### 1.2 扩展 `MonitorDbContext`

**文件**: `XhMonitor.Service/Data/MonitorDbContext.cs`

**修改点 1**: 添加 DbSet (在 line 18 后)
```csharp
public DbSet<ApplicationSettings> ApplicationSettings => Set<ApplicationSettings>();
```

**修改点 2**: 配置种子数据 (在 OnModelCreating 末尾,line 101 后)
```csharp
// ApplicationSettings 表配置
modelBuilder.Entity<ApplicationSettings>(entity =>
{
    // 复合唯一索引: (Category, Key) 组合唯一
    entity.HasIndex(e => new { e.Category, e.Key }).IsUnique();
});

// 种子数据
var seedTimestamp = new DateTime(2025, 1, 1, 0, 0, 0, DateTimeKind.Utc);
modelBuilder.Entity<ApplicationSettings>().HasData(
    // 外观设置 (5项)
    new ApplicationSettings { Id = 1, Category = "Appearance", Key = "ThemeColor", Value = "\"Dark\"", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 2, Category = "Appearance", Key = "Opacity", Value = "60", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 3, Category = "Appearance", Key = "FontSize", Value = "\"Medium\"", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 4, Category = "Appearance", Key = "CpuWarningThreshold", Value = "50", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 5, Category = "Appearance", Key = "CpuDangerThreshold", Value = "80", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    
    // 数据采集设置 (5项)
    new ApplicationSettings { Id = 6, Category = "DataCollection", Key = "ProcessKeywords", Value = "[\"python\",\"llama\"]", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 7, Category = "DataCollection", Key = "SystemInterval", Value = "1000", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 8, Category = "DataCollection", Key = "ProcessInterval", Value = "5000", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 9, Category = "DataCollection", Key = "TopProcessCount", Value = "10", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 10, Category = "DataCollection", Key = "DataRetentionDays", Value = "30", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    
    // 系统设置 (4项)
    new ApplicationSettings { Id = 11, Category = "System", Key = "StartWithWindows", Value = "false", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 12, Category = "System", Key = "SignalRPort", Value = "35179", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 13, Category = "System", Key = "WebPort", Value = "35180", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp },
    new ApplicationSettings { Id = 14, Category = "System", Key = "LogLevel", Value = "\"Debug\"", CreatedAt = seedTimestamp, UpdatedAt = seedTimestamp }
);
```

**预期结果**: DbContext 可操作新表,包含复合索引和种子数据

---

### 1.3 生成 EF Core 迁移

**命令**:
```bash
cd XhMonitor.Service
dotnet ef migrations add AddApplicationSettings
```

**预期结果**:
- 生成 `Migrations/20251229XXXXXX_AddApplicationSettings.cs`
- 更新 `MonitorDbContextModelSnapshot.cs`
- 控制台输出 "Done. To undo this action, use 'ef migrations remove'"

**验证检查**:
```bash
# 查看迁移历史
dotnet ef migrations list
# 应输出: 20251221075010_InitialCreate, 20251229XXXXXX_AddApplicationSettings
```

---

## 🎯 Phase 2: 后端 API 层开发

### 2.1 创建 DTO 模型

**文件**: `XhMonitor.Service/Models/SettingsDto.cs`

```csharp
namespace XhMonitor.Service.Models;

/// <summary>
/// 设置分组 DTO
/// </summary>
public class SettingsGroupDto
{
    public Dictionary<string, Dictionary<string, string>> Settings { get; set; } = new();
}

/// <summary>
/// 设置更新请求 DTO
/// </summary>
public class UpdateSettingRequest
{
    public string Value { get; set; } = string.Empty;
}
```

**预期结果**: DTO 类可用于 API 序列化/反序列化

---

### 2.2 扩展 `ConfigController`

**文件**: `XhMonitor.Service/Controllers/ConfigController.cs`

**添加依赖注入** (在构造函数参数中):
```csharp
private readonly IHubContext<MetricsHub> _hubContext;  // 新增

public ConfigController(
    IDbContextFactory<MonitorDbContext> contextFactory,
    IConfiguration configuration,
    ILogger<ConfigController> logger,
    MetricProviderRegistry providerRegistry,
    IHubContext<MetricsHub> hubContext)  // 新增
{
    // ...
    _hubContext = hubContext;
}
```

**新增 API 端点 1**: 获取所有设置
```csharp
/// <summary>
/// 获取所有应用设置 (按分类分组)
/// </summary>
[HttpGet("settings")]
[ProducesResponseType(typeof(Dictionary<string, Dictionary<string, string>>), 200)]
public async Task<IActionResult> GetSettings()
{
    await using var context = await _contextFactory.CreateDbContextAsync();
    
    var settings = await context.ApplicationSettings
        .OrderBy(s => s.Category)
        .ThenBy(s => s.Key)
        .ToListAsync();
    
    // 按分类分组
    var grouped = settings
        .GroupBy(s => s.Category)
        .ToDictionary(
            g => g.Key,
            g => g.ToDictionary(x => x.Key, x => x.Value)
        );
    
    return Ok(grouped);
}
```

**新增 API 端点 2**: 更新单个配置
```csharp
/// <summary>
/// 更新单个配置项
/// </summary>
/// <param name="category">配置分类</param>
/// <param name="key">配置键</param>
/// <param name="request">配置值</param>
[HttpPut("settings/{category}/{key}")]
[ProducesResponseType(200)]
[ProducesResponseType(404)]
public async Task<IActionResult> UpdateSetting(
    string category,
    string key,
    [FromBody] UpdateSettingRequest request)
{
    await using var context = await _contextFactory.CreateDbContextAsync();
    
    var setting = await context.ApplicationSettings
        .FirstOrDefaultAsync(s => s.Category == category && s.Key == key);
    
    if (setting == null)
    {
        return NotFound(new { Message = $"配置项 {category}.{key} 不存在" });
    }
    
    setting.Value = request.Value;
    setting.UpdatedAt = DateTime.UtcNow;
    
    await context.SaveChangesAsync();
    
    // SignalR 推送配置变更事件
    await _hubContext.Clients.All.SendAsync("settings.updated", category, key, request.Value);
    
    _logger.LogInformation("配置已更新: {Category}.{Key} = {Value}", category, key, request.Value);
    
    return Ok(new { Message = "配置已更新", Category = category, Key = key, Value = request.Value });
}
```

**新增 API 端点 3**: 批量更新配置
```csharp
/// <summary>
/// 批量更新配置 (用于保存整个设置页)
/// </summary>
[HttpPut("settings")]
[ProducesResponseType(200)]
public async Task<IActionResult> UpdateSettings([FromBody] Dictionary<string, Dictionary<string, string>> settings)
{
    await using var context = await _contextFactory.CreateDbContextAsync();
    
    var updatedCount = 0;
    var timestamp = DateTime.UtcNow;
    
    foreach (var categoryGroup in settings)
    {
        var category = categoryGroup.Key;
        foreach (var item in categoryGroup.Value)
        {
            var key = item.Key;
            var value = item.Value;
            
            var setting = await context.ApplicationSettings
                .FirstOrDefaultAsync(s => s.Category == category && s.Key == key);
            
            if (setting != null)
            {
                setting.Value = value;
                setting.UpdatedAt = timestamp;
                updatedCount++;
            }
        }
    }
    
    await context.SaveChangesAsync();
    
    // SignalR 推送批量更新事件
    await _hubContext.Clients.All.SendAsync("settings.batch_updated", settings);
    
    _logger.LogInformation("批量更新 {Count} 个配置项", updatedCount);
    
    return Ok(new { Message = $"成功更新 {updatedCount} 个配置项", UpdatedCount = updatedCount });
}
```

**预期结果**:
- API 端点可通过 Swagger 测试
- 日志正确输出
- SignalR 事件正常推送

---

## 🎯 Phase 3: WPF 设置窗口开发

### 3.1 创建 ViewModel (精简版)

**文件**: `XhMonitor.Desktop/ViewModels/SettingsViewModel.cs`

**更新说明**: 保留数据采集的所有 5 项配置

```csharp
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Net.Http;
using System.Net.Http.Json;
using System.Runtime.CompilerServices;
using System.Text.Json;

namespace XhMonitor.Desktop.ViewModels;

public class SettingsViewModel : INotifyPropertyChanged
{
    private readonly HttpClient _httpClient;
    private const string ApiBaseUrl = "http://localhost:35179/api/v1/config";

    // 外观设置 (精简版)
    private string _themeColor = "Dark";
    private int _opacity = 60;

    // 数据采集设置 (完整版)
    private ObservableCollection<string> _processKeywords = new();
    private int _systemInterval = 1000;
    private int _processInterval = 5000;
    private int _topProcessCount = 10;
    private int _dataRetentionDays = 30;

    // 系统设置
    private bool _startWithWindows = false;
    private int _signalRPort = 35179;
    private int _webPort = 35180;

    private bool _isSaving = false;

    public SettingsViewModel()
    {
        _httpClient = new HttpClient();
    }

    // 属性
    public string ThemeColor
    {
        get => _themeColor;
        set => SetProperty(ref _themeColor, value);
    }

    public int Opacity
    {
        get => _opacity;
        set => SetProperty(ref _opacity, value);
    }

    public ObservableCollection<string> ProcessKeywords
    {
        get => _processKeywords;
        set => SetProperty(ref _processKeywords, value);
    }

    public int SystemInterval
    {
        get => _systemInterval;
        set => SetProperty(ref _systemInterval, value);
    }

    public int ProcessInterval
    {
        get => _processInterval;
        set => SetProperty(ref _processInterval, value);
    }

    public int TopProcessCount
    {
        get => _topProcessCount;
        set => SetProperty(ref _topProcessCount, value);
    }

    public int DataRetentionDays
    {
        get => _dataRetentionDays;
        set => SetProperty(ref _dataRetentionDays, value);
    }

    public bool StartWithWindows
    {
        get => _startWithWindows;
        set => SetProperty(ref _startWithWindows, value);
    }

    public int SignalRPort
    {
        get => _signalRPort;
        set => SetProperty(ref _signalRPort, value);
    }

    public int WebPort
    {
        get => _webPort;
        set => SetProperty(ref _webPort, value);
    }

    public bool IsSaving
    {
        get => _isSaving;
        set => SetProperty(ref _isSaving, value);
    }

    /// <summary>从 API 加载配置</summary>
    public async Task LoadSettingsAsync()
    {
        try
        {
            var response = await _httpClient.GetAsync($"{ApiBaseUrl}/settings");
            response.EnsureSuccessStatusCode();

            var settings = await response.Content.ReadFromJsonAsync<Dictionary<string, Dictionary<string, string>>>();
            if (settings == null) return;

            // 外观设置
            if (settings.TryGetValue("Appearance", out var appearance))
            {
                ThemeColor = JsonSerializer.Deserialize<string>(appearance["ThemeColor"]) ?? "Dark";
                Opacity = int.Parse(appearance["Opacity"]);
            }

            // 数据采集设置
            if (settings.TryGetValue("DataCollection", out var dataCollection))
            {
                var keywords = JsonSerializer.Deserialize<string[]>(dataCollection["ProcessKeywords"]) ?? Array.Empty<string>();
                ProcessKeywords = new ObservableCollection<string>(keywords);
                SystemInterval = int.Parse(dataCollection["SystemInterval"]);
                ProcessInterval = int.Parse(dataCollection["ProcessInterval"]);
                TopProcessCount = int.Parse(dataCollection["TopProcessCount"]);
                DataRetentionDays = int.Parse(dataCollection["DataRetentionDays"]);
            }

            // 系统设置
            if (settings.TryGetValue("System", out var system))
            {
                StartWithWindows = bool.Parse(system["StartWithWindows"]);
                SignalRPort = int.Parse(system["SignalRPort"]);
                WebPort = int.Parse(system["WebPort"]);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"加载配置失败: {ex.Message}");
        }
    }

    /// <summary>保存所有配置</summary>
    public async Task<bool> SaveSettingsAsync()
    {
        IsSaving = true;
        try
        {
            var settings = new Dictionary<string, Dictionary<string, string>>
            {
                ["Appearance"] = new()
                {
                    ["ThemeColor"] = JsonSerializer.Serialize(ThemeColor),
                    ["Opacity"] = Opacity.ToString()
                },
                ["DataCollection"] = new()
                {
                    ["ProcessKeywords"] = JsonSerializer.Serialize(ProcessKeywords.ToArray()),
                    ["SystemInterval"] = SystemInterval.ToString(),
                    ["ProcessInterval"] = ProcessInterval.ToString(),
                    ["TopProcessCount"] = TopProcessCount.ToString(),
                    ["DataRetentionDays"] = DataRetentionDays.ToString()
                },
                ["System"] = new()
                {
                    ["StartWithWindows"] = StartWithWindows.ToString().ToLower(),
                    ["SignalRPort"] = SignalRPort.ToString(),
                    ["WebPort"] = WebPort.ToString()
                }
            };

            var response = await _httpClient.PutAsJsonAsync($"{ApiBaseUrl}/settings", settings);
            response.EnsureSuccessStatusCode();

            return true;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"保存配置失败: {ex.Message}");
            return false;
        }
        finally
        {
            IsSaving = false;
        }
    }

    // INotifyPropertyChanged 实现
    public event PropertyChangedEventHandler? PropertyChanged;
    protected bool SetProperty<T>(ref T field, T value, [CallerMemberName] string? propertyName = null)
    {
        if (EqualityComparer<T>.Default.Equals(field, value)) return false;
        field = value;
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        return true;
    }
}
```

**预期结果**: ViewModel 可正确加载和保存简化后的配置项

---

### 3.2 创建 XAML 窗口 (融合新 UI 设计)

**文件**: `XhMonitor.Desktop/Windows/SettingsWindow.xaml`

**UI 设计更新说明**:
- 窗口尺寸：800x600 (更宽敞)
- 背景色：`#1E1E1E` (更现代化)
- 导航栏宽度：200px
- 左侧蓝色边框指示器 (选中状态)
- 透明度范围：20-100%
- 移除字体大小和 CPU/GPU 阈值配置 (简化 UI)
- 新增"关于"页面
- 按钮样式现代化 (圆角、悬停效果)

```xaml
<Window x:Class="XhMonitor.Desktop.Windows.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:XhMonitor.Desktop.ViewModels"
        mc:Ignorable="d"
        Title="XhMonitor 设置" Height="600" Width="800"
        WindowStartupLocation="CenterScreen" ResizeMode="NoResize"
        Background="#1E1E1E" Foreground="#E0E0E0">

    <Window.DataContext>
        <vm:SettingsViewModel />
    </Window.DataContext>

    <Window.Resources>
        <!-- 现代化按钮样式 -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="#333333"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#444444"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 导航列表项样式 -->
        <Style TargetType="ListBoxItem">
            <Setter Property="Padding" Value="20,15"/>
            <Setter Property="Foreground" Value="#AAAAAA"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Border" Background="Transparent" BorderThickness="4,0,0,0" BorderBrush="Transparent">
                            <ContentPresenter Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#252526"/>
                                <Setter TargetName="Border" Property="BorderBrush" Value="#007ACC"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#2D2D30"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="200"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- 左侧导航栏 -->
        <Border Background="#252526" BorderBrush="#3F3F46" BorderThickness="0,0,1,0">
            <StackPanel>
                <TextBlock Text="设置" FontSize="24" FontWeight="Bold" Margin="20,30,20,30" Foreground="White"/>
                <ListBox x:Name="NavList" Background="Transparent" BorderThickness="0" SelectedIndex="0">
                    <ListBoxItem Content="🎨 外观设置" Tag="Appearance"/>
                    <ListBoxItem Content="📊 数据采集" Tag="Data"/>
                    <ListBoxItem Content="⚙️ 系统选项" Tag="System"/>
                    <ListBoxItem Content="ℹ️ 关于" Tag="About"/>
                </ListBox>
            </StackPanel>
        </Border>

        <!-- 右侧内容区 -->
        <Grid Grid.Column="1" Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 分页内容 (简化版) -->
            <TabControl x:Name="ContentTabControl"
                        Grid.Row="0"
                        Background="Transparent"
                        BorderThickness="0"
                        SelectedIndex="{Binding ElementName=NavList, Path=SelectedIndex}">

                <!-- 页面 1: 外观设置 (简化) -->
                <TabItem Visibility="Collapsed">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="外观设置" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,20" Foreground="White"/>

                            <TextBlock Text="主题颜色" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <ComboBox Height="35" Margin="0,0,0,20" SelectedIndex="0">
                                <ComboBoxItem Content="深色 (Dark)"/>
                                <ComboBoxItem Content="浅色 (Light)"/>
                            </ComboBox>

                            <TextBlock Text="窗口透明度" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <Grid Margin="0,0,0,20">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="50"/>
                                </Grid.ColumnDefinitions>
                                <Slider Maximum="100" Minimum="20" Value="{Binding Opacity}" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" Text="{Binding Opacity, StringFormat={}{0}%}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                            </Grid>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
                
                <!-- 页面 2: 数据采集 (完整版) -->
                <TabItem Visibility="Collapsed">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="数据采集" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,20" Foreground="White"/>

                            <TextBlock Text="进程监控关键词" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <ListBox ItemsSource="{Binding ProcessKeywords}"
                                     Height="120"
                                     Background="#333"
                                     Foreground="White"
                                     BorderThickness="0"
                                     Margin="0,0,0,10"/>
                            <Button Content="+ 添加关键词"
                                    Click="AddKeyword_Click"
                                    Margin="0,0,0,20"
                                    HorizontalAlignment="Left"
                                    Padding="10,5"/>

                            <TextBlock Text="系统指标采集间隔 (毫秒)" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBox Height="35" Text="{Binding SystemInterval}" VerticalContentAlignment="Center" Padding="5" Background="#333" Foreground="White" BorderThickness="0" Margin="0,0,0,20"/>

                            <TextBlock Text="进程指标采集间隔 (毫秒)" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBox Height="35" Text="{Binding ProcessInterval}" VerticalContentAlignment="Center" Padding="5" Background="#333" Foreground="White" BorderThickness="0" Margin="0,0,0,20"/>

                            <TextBlock Text="Top 进程数量" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBox Height="35" Text="{Binding TopProcessCount}" VerticalContentAlignment="Center" Padding="5" Background="#333" Foreground="White" BorderThickness="0" Margin="0,0,0,20"/>

                            <TextBlock Text="历史数据保留时长 (天)" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBox Height="35" Text="{Binding DataRetentionDays}" VerticalContentAlignment="Center" Padding="5" Background="#333" Foreground="White" BorderThickness="0" Margin="0,0,0,20"/>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- 页面 3: 系统选项 -->
                <TabItem Visibility="Collapsed">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="系统选项" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,20" Foreground="White"/>

                            <CheckBox Content="开机自启动" IsChecked="{Binding StartWithWindows}" Foreground="White" Margin="0,0,0,20"/>

                            <TextBlock Text="SignalR 后端端口" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBox Height="35" Text="{Binding SignalRPort}" VerticalContentAlignment="Center" Padding="5" Background="#333" Foreground="White" BorderThickness="0" Margin="0,0,0,20"/>

                            <TextBlock Text="Web 前端端口" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBox Height="35" Text="{Binding WebPort}" VerticalContentAlignment="Center" Padding="5" Background="#333" Foreground="White" BorderThickness="0" Margin="0,0,0,20"/>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- 页面 4: 关于 (新增) -->
                <TabItem Visibility="Collapsed">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="关于" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,20" Foreground="White"/>

                            <TextBlock Text="XhMonitor" FontSize="16" FontWeight="Bold" Foreground="White" Margin="0,0,0,10"/>
                            <TextBlock Text="版本：0.1.0" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBlock Text="轻量级系统性能监控工具" Foreground="#AAAAAA" Margin="0,0,0,20" TextWrapping="Wrap"/>

                            <Separator Margin="0,10,0,20" Background="#3F3F46"/>

                            <TextBlock Text="技术栈" FontSize="14" FontWeight="SemiBold" Foreground="White" Margin="0,0,0,10"/>
                            <TextBlock Foreground="#AAAAAA" TextWrapping="Wrap">
                                • 前端：WPF (.NET 8)<LineBreak/>
                                • 后端：ASP.NET Core + SignalR<LineBreak/>
                                • 数据库：SQLite + EF Core<LineBreak/>
                                • Web：Vue 3 + TypeScript
                            </TextBlock>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
            </TabControl>

            <!-- 底部操作栏 -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                <Button Content="恢复默认" Margin="0,0,10,0" Background="Transparent" Foreground="#AAAAAA" Click="RestoreDefaults_Click"/>
                <Button Content="取 消" Width="100" Margin="0,0,10,0" Click="Cancel_Click"/>
                <Button Content="保 存" Width="100" Background="#007ACC" Click="Save_Click"/>
            </StackPanel>
        </Grid>
    </Grid>
```

**预期结果**: 窗口可正常打开,使用现代化 UI 设计,布局美观

---

### 3.3 创建 Code-Behind (简化版)

**文件**: `XhMonitor.Desktop/Windows/SettingsWindow.xaml.cs`

```csharp
using System.Windows;
using XhMonitor.Desktop.ViewModels;

namespace XhMonitor.Desktop.Windows;

public partial class SettingsWindow : Window
{
    private readonly SettingsViewModel _viewModel;

    public SettingsWindow()
    {
        InitializeComponent();
        _viewModel = (SettingsViewModel)DataContext;

        Loaded += async (s, e) => await _viewModel.LoadSettingsAsync();
    }

    private async void Save_Click(object sender, RoutedEventArgs e)
    {
        var success = await _viewModel.SaveSettingsAsync();
        if (success)
        {
            MessageBox.Show("配置已保存", "成功", MessageBoxButton.OK, MessageBoxImage.Information);
            DialogResult = true;
            Close();
        }
        else
        {
            MessageBox.Show("保存失败,请检查后端服务是否运行", "错误", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void Cancel_Click(object sender, RoutedEventArgs e)
    {
        DialogResult = false;
        Close();
    }

    private async void RestoreDefaults_Click(object sender, RoutedEventArgs e)
    {
        var result = MessageBox.Show(
            "确定要恢复所有设置到默认值吗?",
            "确认",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question);

        if (result == MessageBoxResult.Yes)
        {
            // 恢复默认值
            _viewModel.ThemeColor = "Dark";
            _viewModel.Opacity = 60;
            _viewModel.ProcessKeywords.Clear();
            _viewModel.ProcessKeywords.Add("python");
            _viewModel.ProcessKeywords.Add("llama");
            _viewModel.SystemInterval = 1000;
            _viewModel.ProcessInterval = 5000;
            _viewModel.TopProcessCount = 10;
            _viewModel.DataRetentionDays = 30;
            _viewModel.StartWithWindows = false;
            _viewModel.SignalRPort = 35179;
            _viewModel.WebPort = 35180;
        }
    }

    private void AddKeyword_Click(object sender, RoutedEventArgs e)
    {
        var keyword = Microsoft.VisualBasic.Interaction.InputBox("输入进程关键词:", "添加关键词", "");
        if (!string.IsNullOrWhiteSpace(keyword))
        {
            _viewModel.ProcessKeywords.Add(keyword);
        }
    }
}
```

**预期结果**: 按钮事件正常响应,配置加载/保存逻辑完整

---

### 3.4 修改 `App.xaml.cs` 添加菜单项

**文件**: `XhMonitor.Desktop/App.xaml.cs`

**修改点**: 在 `BuildTrayMenu()` 方法中 (line 84-117)

```csharp
private WinForms.ContextMenuStrip BuildTrayMenu()
{
    var menu = new WinForms.ContextMenuStrip();

    var showItem = new WinForms.ToolStripMenuItem("显示/隐藏");
    showItem.Click += (_, _) => ToggleFloatingWindow();

    var openWebItem = new WinForms.ToolStripMenuItem("打开 Web 界面");
    openWebItem.Click += (_, _) => OpenWebInterface();

    var clickThroughItem = new WinForms.ToolStripMenuItem("点击穿透")
    {
        CheckOnClick = true,
        Checked = _floatingWindow?.IsClickThroughEnabled ?? false
    };
    clickThroughItem.Click += (_, _) =>
    {
        if (_floatingWindow != null)
        {
            _floatingWindow.SetClickThrough(clickThroughItem.Checked);
        }
    };

    // 新增: 设置菜单项 ⭐
    var settingsItem = new WinForms.ToolStripMenuItem("⚙️ 设置");
    settingsItem.Click += (_, _) => OpenSettingsWindow();

    var exitItem = new WinForms.ToolStripMenuItem("退出");
    exitItem.Click += (_, _) => ExitApplication();

    menu.Items.Add(showItem);
    menu.Items.Add(openWebItem);
    menu.Items.Add(clickThroughItem);
    menu.Items.Add(new WinForms.ToolStripSeparator());
    menu.Items.Add(settingsItem);  // ⭐ 新增
    menu.Items.Add(new WinForms.ToolStripSeparator());
    menu.Items.Add(exitItem);

    return menu;
}

// 新增方法 ⭐
private void OpenSettingsWindow()
{
    Dispatcher.Invoke(() =>
    {
        var settingsWindow = new Windows.SettingsWindow
        {
            Owner = _floatingWindow
        };
        settingsWindow.ShowDialog();
    });
}
```

**预期结果**: 任务栏右键菜单出现"⚙️ 设置"选项,点击打开设置窗口

---

## 🎯 Phase 4: SignalR 实时同步集成

### 4.1 修改 `MetricsHub`

**文件**: `XhMonitor.Service/Hubs/MetricsHub.cs`

**添加方法** (在现有方法后):
```csharp
/// <summary>
/// 配置变更通知 (由 ConfigController 调用)
/// </summary>
public async Task NotifySettingChanged(string category, string key, string value)
{
    await Clients.All.SendAsync("settings.updated", category, key, value);
}
```

**预期结果**: Hub 可推送配置变更事件

---

### 4.2 修改 Desktop 的 `SignalRService`

**文件**: `XhMonitor.Desktop/Services/SignalRService.cs`

**添加事件订阅** (在 `StartAsync` 方法中):
```csharp
// 订阅配置变更事件
_connection.On<string, string, string>("settings.updated", (category, key, value) =>
{
    SettingChanged?.Invoke(this, new SettingChangedEventArgs(category, key, value));
});

// 订阅批量配置变更事件
_connection.On<Dictionary<string, Dictionary<string, string>>>("settings.batch_updated", (settings) =>
{
    BatchSettingsChanged?.Invoke(this, new BatchSettingsChangedEventArgs(settings));
});
```

**添加事件定义**:
```csharp
public event EventHandler<SettingChangedEventArgs>? SettingChanged;
public event EventHandler<BatchSettingsChangedEventArgs>? BatchSettingsChanged;

public class SettingChangedEventArgs : EventArgs
{
    public string Category { get; }
    public string Key { get; }
    public string Value { get; }
    
    public SettingChangedEventArgs(string category, string key, string value)
    {
        Category = category;
        Key = key;
        Value = value;
    }
}

public class BatchSettingsChangedEventArgs : EventArgs
{
    public Dictionary<string, Dictionary<string, string>> Settings { get; }
    
    public BatchSettingsChangedEventArgs(Dictionary<string, Dictionary<string, string>> settings)
    {
        Settings = settings;
    }
}
```

**预期结果**: Desktop 可接收配置变更事件

---

## 🎯 Phase 5: 测试与集成

### 5.1 数据库迁移测试

**操作步骤**:
1. 停止后端服务
2. 删除 `xhmonitor.db` (可选,测试全新初始化)
3. 启动后端服务
4. 检查日志输出 "数据库迁移完成"
5. 使用 SQLite 工具验证表结构和种子数据

**验证命令**:
```bash
sqlite3 xhmonitor.db
.schema ApplicationSettings
SELECT * FROM ApplicationSettings;
```

**预期结果**:
```sql
CREATE TABLE ApplicationSettings (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Category TEXT NOT NULL,
    Key TEXT NOT NULL,
    Value TEXT NOT NULL,
    CreatedAt TEXT NOT NULL,
    UpdatedAt TEXT NOT NULL
);
-- 14 行种子数据
```

---

### 5.2 API 功能测试

**测试用例 1**: 获取所有配置
```bash
curl http://localhost:35179/api/v1/config/settings
```

**预期响应**:
```json
{
  "Appearance": {
    "ThemeColor": "\"Dark\"",
    "Opacity": "60",
    ...
  },
  "DataCollection": {...},
  "System": {...}
}
```

**测试用例 2**: 更新单个配置
```bash
curl -X PUT http://localhost:35179/api/v1/config/settings/Appearance/Opacity \
  -H "Content-Type: application/json" \
  -d '{"Value": "80"}'
```

**预期响应**:
```json
{
  "message": "配置已更新",
  "category": "Appearance",
  "key": "Opacity",
  "value": "80"
}
```

---

### 5.3 UI 集成测试

**测试步骤**:
1. 启动 Desktop 应用
2. 右键任务栏图标 → 点击"⚙️ 设置"
3. 验证设置窗口打开
4. 修改任意配置项
5. 点击"保存"按钮
6. 检查后端日志是否输出 "配置已更新"
7. 关闭设置窗口
8. 重新打开设置窗口
9. 验证配置是否持久化

**预期结果**: 所有配置正确保存和加载

---

### 5.4 SignalR 实时同步测试

**测试步骤**:
1. 同时打开 Desktop 应用和 Web 界面
2. 在 Desktop 设置窗口修改配置
3. 观察 Web 界面是否实时更新
4. 在 Web 界面修改配置
5. 观察 Desktop 是否收到推送

**预期结果**: 配置变更实时同步到所有客户端

---

## 📋 任务清单总结

| 阶段 | 任务 | 文件数 | 预计时间 |
|------|------|--------|---------|
| **Phase 1: 数据层** | 实体类 + DbContext + 迁移 | 3 | 30 分钟 |
| **Phase 2: API 层** | DTO + Controller + Hub | 2 | 45 分钟 |
| **Phase 3: UI 层** | ViewModel + XAML + Code-Behind | 3 | 90 分钟 |
| **Phase 4: SignalR** | 事件订阅 + 推送 | 2 | 30 分钟 |
| **Phase 5: 测试** | 单元测试 + 集成测试 | - | 45 分钟 |
| **总计** | - | **10 个文件** | **4 小时** |

---

## ⚠️ 风险点与注意事项

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| EF 迁移冲突 | 数据库初始化失败 | 先备份 db 文件,迁移前检查 ModelSnapshot |
| JSON 序列化错误 | 配置读取失败 | 使用 `JsonSerializer` 统一处理,添加 try-catch |
| SignalR 连接断开 | 配置推送失败 | 客户端实现自动重连 (已有) |
| 端口修改生效时机 | 用户误以为立即生效 | UI 添加明显警告提示 |
| 并发修改配置 | 数据覆盖 | 使用 `UpdatedAt` 字段乐观锁 |

---

## 🎯 下一步行动

**当前阶段**: [模式:计划] ✅ 已完成详细实施计划

**计划已保存到**: `.claude/plan/设置菜单功能.md` (将在执行阶段创建)

**是否批准此计划并进入 [模式:执行] 阶段?**

请回复 **"Y"** 或 **"批准"** 开始实施,我将严格按照上述步骤执行。

如需调整计划,请告知具体修改点。🙏
