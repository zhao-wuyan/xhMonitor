<Window x:Class="XhMonitor.Desktop.FloatingWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:XhMonitor.Desktop"
        xmlns:vm="clr-namespace:XhMonitor.Desktop.ViewModels"
        Title="XhMonitor"
        SizeToContent="WidthAndHeight"
        WindowStyle="None"
        ResizeMode="NoResize"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False">

    <Window.Resources>
        <!-- è½¬æ¢å™¨ -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>

        <!-- é˜ˆå€¼æ¸å˜ç”»åˆ· -->
        <LinearGradientBrush x:Key="ThresholdBrush" StartPoint="0,0" EndPoint="1,0">
            <GradientStop Color="#4CAF50" Offset="0.0"/>
            <GradientStop Color="#4CAF50" Offset="0.49"/>
            <GradientStop Color="#FFC107" Offset="0.50"/>
            <GradientStop Color="#FFC107" Offset="0.79"/>
            <GradientStop Color="#F44336" Offset="0.80"/>
            <GradientStop Color="#F44336" Offset="1.0"/>
        </LinearGradientBrush>

        <!-- 3px é«˜åº¦è¿›åº¦æ¡æ ·å¼ -->
        <Style x:Key="ThinProgressBar" TargetType="ProgressBar">
            <Setter Property="Height" Value="3"/>
            <Setter Property="Minimum" Value="0"/>
            <Setter Property="Maximum" Value="100"/>
            <Setter Property="Background" Value="#33FFFFFF"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ProgressBar">
                        <Grid>
                            <Border Background="{TemplateBinding Background}" CornerRadius="1.5"/>
                            <Border x:Name="PART_Track" CornerRadius="1.5"/>
                            <Border x:Name="PART_Indicator" HorizontalAlignment="Left" CornerRadius="1.5"
                                    Background="{StaticResource ThresholdBrush}">
                                <Border.Width>
                                    <MultiBinding>
                                        <MultiBinding.Converter>
                                            <local:ProgressWidthConverter/>
                                        </MultiBinding.Converter>
                                        <Binding Path="Value" RelativeSource="{RelativeSource TemplatedParent}"/>
                                        <Binding Path="ActualWidth" RelativeSource="{RelativeSource TemplatedParent}"/>
                                        <Binding Path="Maximum" RelativeSource="{RelativeSource TemplatedParent}"/>
                                    </MultiBinding>
                                </Border.Width>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- æŒ‡æ ‡é¡¹æ¨¡æ¿ -->
        <DataTemplate x:Key="MetricItemTemplate">
            <StackPanel Margin="8,4">
                <TextBlock Text="{Binding Label}" FontSize="9" Foreground="#888" FontFamily="Segoe UI"/>
                <TextBlock Text="{Binding ValueText}" FontSize="11" Foreground="White" FontWeight="Bold" FontFamily="Consolas"/>
                <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding Value}" Margin="0,2,0,0"/>
            </StackPanel>
        </DataTemplate>

        <!-- è¿›ç¨‹è¡Œæ¨¡æ¿ -->
        <DataTemplate x:Key="ProcessRowTemplate" DataType="{x:Type vm:FloatingWindowViewModel+ProcessRowViewModel}">
            <Border Background="#11FFFFFF" CornerRadius="4" Padding="8,4" Margin="0,1">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Toggle Pin" Click="ProcessRow_TogglePin" Tag="{Binding}"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="50"/>
                        <ColumnDefinition Width="50"/>
                        <ColumnDefinition Width="50"/>
                        <ColumnDefinition Width="55"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="ðŸ“Œ" Visibility="{Binding IsPinned, Converter={StaticResource BoolToVisibility}}" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Text="{Binding ProcessName}" Foreground="White" FontSize="11" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                    <StackPanel Grid.Column="2" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Gpu, StringFormat={}{0:F1}%}" Foreground="#4FC3F7" FontSize="10" FontFamily="Consolas"/>
                        <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding Gpu, Mode=OneWay}" Height="2"/>
                    </StackPanel>
                    <StackPanel Grid.Column="3" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Cpu, StringFormat={}{0:F1}%}" Foreground="#FF6B6B" FontSize="10" FontFamily="Consolas"/>
                        <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding Cpu, Mode=OneWay}" Height="2"/>
                    </StackPanel>
                    <StackPanel Grid.Column="4" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Memory, StringFormat={}{0:F0}}" Foreground="#50C878" FontSize="10" FontFamily="Consolas"/>
                        <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding Memory, Mode=OneWay}" Maximum="16384" Height="2"/>
                    </StackPanel>
                    <StackPanel Grid.Column="5" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Vram, StringFormat={}{0:F0}}" Foreground="#FFA726" FontSize="10" FontFamily="Consolas"/>
                        <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding Vram, Mode=OneWay}" Maximum="16384" Height="2"/>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- é’‰ä½å¡ç‰‡æ¨¡æ¿ -->
        <DataTemplate x:Key="PinnedCardTemplate" DataType="{x:Type vm:FloatingWindowViewModel+ProcessRowViewModel}">
            <Border Background="#CC1A1A1A" CornerRadius="6" Padding="8,6" Margin="0,0,0,4" Width="300">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.3"/>
                </Border.Effect>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="45"/>
                        <ColumnDefinition Width="45"/>
                        <ColumnDefinition Width="50"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="{Binding ProcessName}" Foreground="White" FontSize="11" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                    <TextBlock Grid.Column="1" Text="{Binding Gpu, StringFormat={}{0:F1}%}" Foreground="#4FC3F7" FontSize="10" FontFamily="Consolas" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="2" Text="{Binding Cpu, StringFormat={}{0:F1}%}" Foreground="#FF6B6B" FontSize="10" FontFamily="Consolas" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="3" Text="{Binding Memory, StringFormat={}{0:F0}MB}" Foreground="#50C878" FontSize="10" FontFamily="Consolas" VerticalAlignment="Center"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- SlideIn åŠ¨ç”» -->
        <Storyboard x:Key="SlideInStoryboard">
            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.2"/>
            <ThicknessAnimation Storyboard.TargetProperty="Margin" From="0,-10,0,0" To="0,0,0,0" Duration="0:0:0.2">
                <ThicknessAnimation.EasingFunction>
                    <QuadraticEase EasingMode="EaseOut"/>
                </ThicknessAnimation.EasingFunction>
            </ThicknessAnimation>
        </Storyboard>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Pinned Stack -->
        <ItemsControl Grid.Row="0" ItemsSource="{Binding PinnedProcesses}"
                      ItemTemplate="{StaticResource PinnedCardTemplate}"
                      HorizontalAlignment="Center" Margin="0,0,0,4">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Vertical"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
        </ItemsControl>

        <!-- Monitor Bar -->
        <Border Grid.Row="1" x:Name="MonitorBar" Background="#E6141414" CornerRadius="8"
                BorderBrush="#33FFFFFF" BorderThickness="1" Padding="4,6"
                MouseEnter="MonitorBar_MouseEnter" MouseLeave="MonitorBar_MouseLeave"
                MouseLeftButtonUp="MonitorBar_MouseLeftButtonUp">
            <Border.Effect>
                <DropShadowEffect BlurRadius="12" ShadowDepth="4" Opacity="0.4"/>
            </Border.Effect>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="1"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="1"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="1"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- CPU -->
                <StackPanel Grid.Column="0" Margin="8,2" MinWidth="55">
                    <TextBlock Text="CPU" FontSize="9" Foreground="#888"/>
                    <TextBlock Text="{Binding TotalCpu, StringFormat={}{0:F1}%}" FontSize="11" Foreground="#FF6B6B" FontWeight="Bold" FontFamily="Consolas"/>
                    <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding TotalCpu, Mode=OneWay}" Margin="0,2,0,0"/>
                </StackPanel>

                <Rectangle Grid.Column="1" Width="1" Fill="#33FFFFFF" Margin="0,4"/>

                <!-- RAM -->
                <StackPanel Grid.Column="2" Margin="8,2" MinWidth="55">
                    <TextBlock Text="RAM" FontSize="9" Foreground="#888"/>
                    <TextBlock Text="{Binding TotalMemory, StringFormat={}{0:F0}MB}" FontSize="11" Foreground="#50C878" FontWeight="Bold" FontFamily="Consolas"/>
                    <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding TotalMemory, Mode=OneWay}" Maximum="32768" Margin="0,2,0,0"/>
                </StackPanel>

                <Rectangle Grid.Column="3" Width="1" Fill="#33FFFFFF" Margin="0,4"/>

                <!-- GPU -->
                <StackPanel Grid.Column="4" Margin="8,2" MinWidth="55">
                    <TextBlock Text="GPU" FontSize="9" Foreground="#888"/>
                    <TextBlock Text="{Binding TotalGpu, StringFormat={}{0:F1}%}" FontSize="11" Foreground="#4FC3F7" FontWeight="Bold" FontFamily="Consolas"/>
                    <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding TotalGpu, Mode=OneWay}" Margin="0,2,0,0"/>
                </StackPanel>

                <Rectangle Grid.Column="5" Width="1" Fill="#33FFFFFF" Margin="0,4"/>

                <!-- VRAM -->
                <StackPanel Grid.Column="6" Margin="8,2" MinWidth="55">
                    <TextBlock Text="VRAM" FontSize="9" Foreground="#888"/>
                    <TextBlock Text="{Binding TotalVram, StringFormat={}{0:F0}MB}" FontSize="11" Foreground="#FFA726" FontWeight="Bold" FontFamily="Consolas"/>
                    <ProgressBar Style="{StaticResource ThinProgressBar}" Value="{Binding TotalVram, Mode=OneWay}" Maximum="16384" Margin="0,2,0,0"/>
                </StackPanel>

                <!-- Pin Indicator -->
                <Border Grid.Column="7" Width="12" Height="12" CornerRadius="6" Margin="6,0,4,0"
                        VerticalAlignment="Center" Cursor="Hand"
                        MouseLeftButtonUp="PinIndicator_Click">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Background" Value="#4CAF50"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsConnected}" Value="False">
                                    <Setter Property="Background" Value="#F44336"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsLocked}" Value="True">
                                    <Setter Property="Background" Value="#2196F3"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                </Border>
            </Grid>
        </Border>

        <!-- Details Panel (Popup) -->
        <Popup Grid.Row="2" x:Name="DetailsPopup" PlacementTarget="{Binding ElementName=MonitorBar}"
               Placement="Bottom" StaysOpen="True" AllowsTransparency="True"
               IsOpen="{Binding IsDetailsVisible, Mode=OneWay}">
            <Border Background="#F0141414" CornerRadius="8" BorderBrush="#33FFFFFF"
                    BorderThickness="1" Padding="8" MinWidth="360" MaxHeight="300">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="16" ShadowDepth="6" Opacity="0.5"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Grid Grid.Row="0" Margin="0,0,0,6">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="55"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="1" Text="Process" Foreground="#666" FontSize="9"/>
                        <TextBlock Grid.Column="2" Text="GPU" Foreground="#666" FontSize="9"/>
                        <TextBlock Grid.Column="3" Text="CPU" Foreground="#666" FontSize="9"/>
                        <TextBlock Grid.Column="4" Text="RAM" Foreground="#666" FontSize="9"/>
                        <TextBlock Grid.Column="5" Text="VRAM" Foreground="#666" FontSize="9"/>
                    </Grid>

                    <!-- Process List -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" MaxHeight="260">
                        <ItemsControl x:Name="ProcessList" ItemsSource="{Binding AllProcesses}"
                                      ItemTemplate="{StaticResource ProcessRowTemplate}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Vertical"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</Window>
